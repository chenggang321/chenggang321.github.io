<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>如何使用 docker 部署前端项目 | 博客</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <meta name="description" content="一个值得收藏的博客，涵盖了前端、后端、运维等关键技术。">
    
    <link rel="preload" href="/assets/css/0.styles.decdc3e0.css" as="style"><link rel="preload" href="/assets/js/app.4f4ef6e8.js" as="script"><link rel="preload" href="/assets/js/2.b1de68ec.js" as="script"><link rel="preload" href="/assets/js/36.4a5a45e3.js" as="script"><link rel="prefetch" href="/assets/js/10.ab3f99ad.js"><link rel="prefetch" href="/assets/js/100.c81995d2.js"><link rel="prefetch" href="/assets/js/101.d6704593.js"><link rel="prefetch" href="/assets/js/102.a7a3e5a5.js"><link rel="prefetch" href="/assets/js/103.50f9015f.js"><link rel="prefetch" href="/assets/js/104.e2bee3c6.js"><link rel="prefetch" href="/assets/js/105.2ee035f2.js"><link rel="prefetch" href="/assets/js/106.3078fc48.js"><link rel="prefetch" href="/assets/js/107.e6576c7d.js"><link rel="prefetch" href="/assets/js/108.6e586c28.js"><link rel="prefetch" href="/assets/js/109.ecde7cf8.js"><link rel="prefetch" href="/assets/js/11.c48f519a.js"><link rel="prefetch" href="/assets/js/110.6641473f.js"><link rel="prefetch" href="/assets/js/111.8f2a5a0b.js"><link rel="prefetch" href="/assets/js/112.83d88710.js"><link rel="prefetch" href="/assets/js/113.bd8649a4.js"><link rel="prefetch" href="/assets/js/114.d80d74ff.js"><link rel="prefetch" href="/assets/js/115.e104d185.js"><link rel="prefetch" href="/assets/js/116.01177820.js"><link rel="prefetch" href="/assets/js/117.c97cce82.js"><link rel="prefetch" href="/assets/js/118.57091e41.js"><link rel="prefetch" href="/assets/js/119.fbc29d3d.js"><link rel="prefetch" href="/assets/js/12.4af41c18.js"><link rel="prefetch" href="/assets/js/120.9c94d5b1.js"><link rel="prefetch" href="/assets/js/121.a45c247c.js"><link rel="prefetch" href="/assets/js/122.18142e32.js"><link rel="prefetch" href="/assets/js/123.5111d68f.js"><link rel="prefetch" href="/assets/js/124.bab3e582.js"><link rel="prefetch" href="/assets/js/125.30969020.js"><link rel="prefetch" href="/assets/js/126.5fea7783.js"><link rel="prefetch" href="/assets/js/127.e8670bd7.js"><link rel="prefetch" href="/assets/js/128.635880cb.js"><link rel="prefetch" href="/assets/js/129.709853ca.js"><link rel="prefetch" href="/assets/js/13.3383eeb2.js"><link rel="prefetch" href="/assets/js/130.cb9c6e3d.js"><link rel="prefetch" href="/assets/js/131.47d3ded4.js"><link rel="prefetch" href="/assets/js/132.ac39324d.js"><link rel="prefetch" href="/assets/js/133.40c44fdc.js"><link rel="prefetch" href="/assets/js/134.2c87bf61.js"><link rel="prefetch" href="/assets/js/135.cd1ebec4.js"><link rel="prefetch" href="/assets/js/136.4c2976f3.js"><link rel="prefetch" href="/assets/js/137.af4cb7f3.js"><link rel="prefetch" href="/assets/js/138.2fca9d79.js"><link rel="prefetch" href="/assets/js/139.68b09848.js"><link rel="prefetch" href="/assets/js/14.10a5d7d6.js"><link rel="prefetch" href="/assets/js/140.83329d13.js"><link rel="prefetch" href="/assets/js/141.ce53e2d1.js"><link rel="prefetch" href="/assets/js/142.90de57a3.js"><link rel="prefetch" href="/assets/js/143.2ceb4dba.js"><link rel="prefetch" href="/assets/js/144.bb562f25.js"><link rel="prefetch" href="/assets/js/145.df7e837b.js"><link rel="prefetch" href="/assets/js/146.07c0d14b.js"><link rel="prefetch" href="/assets/js/147.29278301.js"><link rel="prefetch" href="/assets/js/148.214ec574.js"><link rel="prefetch" href="/assets/js/149.91a2b877.js"><link rel="prefetch" href="/assets/js/15.bbd8bb55.js"><link rel="prefetch" href="/assets/js/150.e682d7a9.js"><link rel="prefetch" href="/assets/js/151.7f512db9.js"><link rel="prefetch" href="/assets/js/152.bde5306e.js"><link rel="prefetch" href="/assets/js/153.ddd305dd.js"><link rel="prefetch" href="/assets/js/154.9ce2066d.js"><link rel="prefetch" href="/assets/js/155.6b4020df.js"><link rel="prefetch" href="/assets/js/156.e6646c1c.js"><link rel="prefetch" href="/assets/js/157.9b95854c.js"><link rel="prefetch" href="/assets/js/158.435aaec3.js"><link rel="prefetch" href="/assets/js/159.b19fafca.js"><link rel="prefetch" href="/assets/js/16.f42084e9.js"><link rel="prefetch" href="/assets/js/160.68710c08.js"><link rel="prefetch" href="/assets/js/161.f1af8369.js"><link rel="prefetch" href="/assets/js/162.48fcf4ef.js"><link rel="prefetch" href="/assets/js/163.06cd6567.js"><link rel="prefetch" href="/assets/js/164.769d0e38.js"><link rel="prefetch" href="/assets/js/165.cc786f58.js"><link rel="prefetch" href="/assets/js/166.8397915c.js"><link rel="prefetch" href="/assets/js/167.f330642c.js"><link rel="prefetch" href="/assets/js/168.7027298e.js"><link rel="prefetch" href="/assets/js/169.639addba.js"><link rel="prefetch" href="/assets/js/17.85928616.js"><link rel="prefetch" href="/assets/js/170.e464e07e.js"><link rel="prefetch" href="/assets/js/171.0c93f5f0.js"><link rel="prefetch" href="/assets/js/172.2bf96d48.js"><link rel="prefetch" href="/assets/js/173.d5f9688e.js"><link rel="prefetch" href="/assets/js/174.e2597c57.js"><link rel="prefetch" href="/assets/js/175.0db8dfdf.js"><link rel="prefetch" href="/assets/js/176.07d902fe.js"><link rel="prefetch" href="/assets/js/177.7ab96d33.js"><link rel="prefetch" href="/assets/js/178.336d8024.js"><link rel="prefetch" href="/assets/js/179.e3c6d94f.js"><link rel="prefetch" href="/assets/js/18.9934e679.js"><link rel="prefetch" href="/assets/js/180.df5400c0.js"><link rel="prefetch" href="/assets/js/181.0c7d5607.js"><link rel="prefetch" href="/assets/js/182.e888e6de.js"><link rel="prefetch" href="/assets/js/183.dce39526.js"><link rel="prefetch" href="/assets/js/184.431b197c.js"><link rel="prefetch" href="/assets/js/185.14793f4e.js"><link rel="prefetch" href="/assets/js/186.9568dba6.js"><link rel="prefetch" href="/assets/js/187.d3fd4988.js"><link rel="prefetch" href="/assets/js/188.aa6e0ffd.js"><link rel="prefetch" href="/assets/js/189.19e95b5f.js"><link rel="prefetch" href="/assets/js/19.ee04512f.js"><link rel="prefetch" href="/assets/js/190.0357c8ab.js"><link rel="prefetch" href="/assets/js/191.38a8d75e.js"><link rel="prefetch" href="/assets/js/192.88ad2e90.js"><link rel="prefetch" href="/assets/js/193.c40d1edf.js"><link rel="prefetch" href="/assets/js/194.5b1b41e8.js"><link rel="prefetch" href="/assets/js/195.760f24ae.js"><link rel="prefetch" href="/assets/js/196.6ffbac14.js"><link rel="prefetch" href="/assets/js/197.4a9b3a84.js"><link rel="prefetch" href="/assets/js/198.8f443da6.js"><link rel="prefetch" href="/assets/js/20.0aaa73a2.js"><link rel="prefetch" href="/assets/js/21.3f7c64b3.js"><link rel="prefetch" href="/assets/js/22.c0a7a6c8.js"><link rel="prefetch" href="/assets/js/23.f6eef774.js"><link rel="prefetch" href="/assets/js/24.bd35123b.js"><link rel="prefetch" href="/assets/js/25.8fcfb8ee.js"><link rel="prefetch" href="/assets/js/26.690a6980.js"><link rel="prefetch" href="/assets/js/27.19f45fe0.js"><link rel="prefetch" href="/assets/js/28.807fab84.js"><link rel="prefetch" href="/assets/js/29.0b6c2e62.js"><link rel="prefetch" href="/assets/js/3.579763e7.js"><link rel="prefetch" href="/assets/js/30.315a7e60.js"><link rel="prefetch" href="/assets/js/31.d5f68890.js"><link rel="prefetch" href="/assets/js/32.d1a6a3df.js"><link rel="prefetch" href="/assets/js/33.3f0448f8.js"><link rel="prefetch" href="/assets/js/34.3a80866b.js"><link rel="prefetch" href="/assets/js/35.365ffa2a.js"><link rel="prefetch" href="/assets/js/37.20e06547.js"><link rel="prefetch" href="/assets/js/38.4f772311.js"><link rel="prefetch" href="/assets/js/39.4c23d572.js"><link rel="prefetch" href="/assets/js/4.67785188.js"><link rel="prefetch" href="/assets/js/40.b322f222.js"><link rel="prefetch" href="/assets/js/41.66a29335.js"><link rel="prefetch" href="/assets/js/42.816686f3.js"><link rel="prefetch" href="/assets/js/43.000306d3.js"><link rel="prefetch" href="/assets/js/44.b02a4caf.js"><link rel="prefetch" href="/assets/js/45.8b184934.js"><link rel="prefetch" href="/assets/js/46.b6c9a6a4.js"><link rel="prefetch" href="/assets/js/47.866ecd20.js"><link rel="prefetch" href="/assets/js/48.d7b42bd4.js"><link rel="prefetch" href="/assets/js/49.2b954b65.js"><link rel="prefetch" href="/assets/js/5.cd5aa464.js"><link rel="prefetch" href="/assets/js/50.f8d28fa1.js"><link rel="prefetch" href="/assets/js/51.35847692.js"><link rel="prefetch" href="/assets/js/52.21725cad.js"><link rel="prefetch" href="/assets/js/53.523b2551.js"><link rel="prefetch" href="/assets/js/54.561bd3c9.js"><link rel="prefetch" href="/assets/js/55.0bf4813c.js"><link rel="prefetch" href="/assets/js/56.911d2a21.js"><link rel="prefetch" href="/assets/js/57.8be7f8ec.js"><link rel="prefetch" href="/assets/js/58.f7a8d551.js"><link rel="prefetch" href="/assets/js/59.a0099645.js"><link rel="prefetch" href="/assets/js/6.6af4007f.js"><link rel="prefetch" href="/assets/js/60.63904601.js"><link rel="prefetch" href="/assets/js/61.c222ba90.js"><link rel="prefetch" href="/assets/js/62.4512acf6.js"><link rel="prefetch" href="/assets/js/63.7fff9229.js"><link rel="prefetch" href="/assets/js/64.e13ed838.js"><link rel="prefetch" href="/assets/js/65.f5a83f6a.js"><link rel="prefetch" href="/assets/js/66.1eec7166.js"><link rel="prefetch" href="/assets/js/67.d08c50bb.js"><link rel="prefetch" href="/assets/js/68.eb803b99.js"><link rel="prefetch" href="/assets/js/69.2375bb03.js"><link rel="prefetch" href="/assets/js/7.df165250.js"><link rel="prefetch" href="/assets/js/70.33f1f6de.js"><link rel="prefetch" href="/assets/js/71.8bcdde8a.js"><link rel="prefetch" href="/assets/js/72.3c3c8dd8.js"><link rel="prefetch" href="/assets/js/73.e808082e.js"><link rel="prefetch" href="/assets/js/74.7ce1cdbc.js"><link rel="prefetch" href="/assets/js/75.21f62d3a.js"><link rel="prefetch" href="/assets/js/76.32052c0d.js"><link rel="prefetch" href="/assets/js/77.a41818c8.js"><link rel="prefetch" href="/assets/js/78.d68c2376.js"><link rel="prefetch" href="/assets/js/79.0b601b4b.js"><link rel="prefetch" href="/assets/js/8.ae557884.js"><link rel="prefetch" href="/assets/js/80.a4f6779f.js"><link rel="prefetch" href="/assets/js/81.84bdd118.js"><link rel="prefetch" href="/assets/js/82.fc561f2d.js"><link rel="prefetch" href="/assets/js/83.2f4de683.js"><link rel="prefetch" href="/assets/js/84.11c361d5.js"><link rel="prefetch" href="/assets/js/85.906325b5.js"><link rel="prefetch" href="/assets/js/86.a2fa9aca.js"><link rel="prefetch" href="/assets/js/87.5caf9cf4.js"><link rel="prefetch" href="/assets/js/88.09b23cce.js"><link rel="prefetch" href="/assets/js/89.cb58b8bb.js"><link rel="prefetch" href="/assets/js/9.28706e90.js"><link rel="prefetch" href="/assets/js/90.9d0167ea.js"><link rel="prefetch" href="/assets/js/91.8c109a6b.js"><link rel="prefetch" href="/assets/js/92.c8dde281.js"><link rel="prefetch" href="/assets/js/93.ad100e18.js"><link rel="prefetch" href="/assets/js/94.15c9e757.js"><link rel="prefetch" href="/assets/js/95.eed9740d.js"><link rel="prefetch" href="/assets/js/96.1d2dc1ce.js"><link rel="prefetch" href="/assets/js/97.0f5f9b90.js"><link rel="prefetch" href="/assets/js/98.8555cbfc.js"><link rel="prefetch" href="/assets/js/99.fa14ad63.js">
    <link rel="stylesheet" href="/assets/css/0.styles.decdc3e0.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/note/git/git-tips.html" class="nav-link">
  随记
</a></div><div class="nav-item"><a href="/study/javascript设计模式-张容铭/1-灵活的JavaScript.html" class="nav-link">
  学习笔记
</a></div> <a href="https://github.com/chenggang321/blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/note/git/git-tips.html" class="nav-link">
  随记
</a></div><div class="nav-item"><a href="/study/javascript设计模式-张容铭/1-灵活的JavaScript.html" class="nav-link">
  学习笔记
</a></div> <a href="https://github.com/chenggang321/blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>git</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>http</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>javascript</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>linux</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>react</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>前端工程化</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/note/前端工程化/2021-fe-predict.html" class="sidebar-link">ESM 大势所趋</a></li><li><a href="/note/前端工程化/bundle.html" class="sidebar-link">前端高级进阶：如何更好地优化打包资源</a></li><li><a href="/note/前端工程化/cdn.html" class="sidebar-link">使用 CDN 加速你的网站</a></li><li><a href="/note/前端工程化/deploy.html" class="sidebar-link">前端部署的发展历程</a></li><li><a href="/note/前端工程化/docker.html" class="active sidebar-link">如何使用 docker 部署前端项目</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/note/前端工程化/docker.html#先让它跑起来" class="sidebar-link">先让它跑起来</a></li><li class="sidebar-sub-header"><a href="/note/前端工程化/docker.html#利用镜像缓存" class="sidebar-link">利用镜像缓存</a></li><li class="sidebar-sub-header"><a href="/note/前端工程化/docker.html#ci-环境下的优化" class="sidebar-link">CI 环境下的优化</a></li><li class="sidebar-sub-header"><a href="/note/前端工程化/docker.html#多阶段构建" class="sidebar-link">多阶段构建</a></li><li class="sidebar-sub-header"><a href="/note/前端工程化/docker.html#使用对象存储服务-oss" class="sidebar-link">使用对象存储服务 (OSS)</a></li><li class="sidebar-sub-header"><a href="/note/前端工程化/docker.html#小结" class="sidebar-link">小结</a></li></ul></li><li><a href="/note/前端工程化/eslint.html" class="sidebar-link">团队编码规范约束最佳实践</a></li><li><a href="/note/前端工程化/esm.html" class="sidebar-link">浏览器中的原生 ESM</a></li><li><a href="/note/前端工程化/feature-deploy.html" class="sidebar-link">CICD 下前端的多特性分支环境部署</a></li><li><a href="/note/前端工程化/http-cache.html" class="sidebar-link">网站的缓存控制策略最佳实践及注意事项</a></li><li><a href="/note/前端工程化/local-https.html" class="sidebar-link">在本地环境为前端项目配置 https</a></li><li><a href="/note/前端工程化/npm-ci.html" class="sidebar-link">生产环境中使用 npm ci 代替 npm i</a></li><li><a href="/note/前端工程化/npm-install.html" class="sidebar-link">在生产环境中使你的 npm i 速度提升 50%</a></li><li><a href="/note/前端工程化/uglify.html" class="sidebar-link">javascript 代码是如何被压缩的</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>微信</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>文章整理</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="如何使用-docker-部署前端项目"><a href="#如何使用-docker-部署前端项目" class="header-anchor">#</a> 如何使用 docker 部署前端项目</h1> <p>Docker 变得越来越流行，它可以轻便灵活地隔离环境，进行扩容，运维管理。对于业务开发者而言，随着持续集成的发展，对代码质量及快速迭代的要求也越来越高。</p> <p>对于前端而言，在 CI 环境中使用也更容易集成开发，测试与部署。比如可以为流水线(Pipeline)设置 Lint/Test/Security/Audit/Deploy/Artifact 等任务，更好地把控项目质量。</p> <p>现在无论是前端，后端还是运维，都很强调 <code>devops</code> 的理念，接下来我将会写一系列关于 <code>devops</code> 在前端中应用的文章。你可以在我的博客 <a href="https://github.com/shfshanyue/blog" target="_blank" rel="noopener noreferrer">https://github.com/shfshanyue/blog<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 中或者我的公众号 【全栈成长之路】中订阅更多文章。</p> <p>这里将介绍如何使用 Docker 部署前端应用，千里之行，始于足下。始于足下的意思就是，先让它能够跑起来。</p> <h2 id="先让它跑起来"><a href="#先让它跑起来" class="header-anchor">#</a> 先让它跑起来</h2> <p>首先，简单介绍一下一个典型的前端应用部署流程</p> <ol><li><code>npm install</code>, 安装依赖</li> <li><code>npm run build</code>，编译，打包，生成静态资源</li> <li>服务化静态资源，如 nginx</li></ol> <p>介绍完部署流程后，简单写一个 Dockerfile</p> <div class="language-dockerfile extra-class"><pre class="language-dockerfile"><code><span class="token keyword">FROM</span> node<span class="token punctuation">:</span>10<span class="token punctuation">-</span>alpine

<span class="token comment"># 代表生产环境</span>
<span class="token keyword">ENV</span> PROJECT_ENV production

<span class="token comment"># 许多 package 会根据此环境变量，做出不同的行为</span>
<span class="token comment"># 另外，在 webpack 中打包也会根据此环境变量做出优化，但是 create-react-app 在打包时会写死该环境变量</span>
<span class="token keyword">ENV</span> NODE_ENV production

<span class="token keyword">WORKDIR</span> /code
<span class="token keyword">ADD</span> . /code
<span class="token keyword">RUN</span> npm install &amp;&amp; npm run build &amp;&amp; npm install <span class="token punctuation">-</span>g http<span class="token punctuation">-</span>server
<span class="token keyword">EXPOSE</span> 80

<span class="token keyword">CMD</span> http<span class="token punctuation">-</span>server ./public <span class="token punctuation">-</span>p 80
</code></pre></div><p>现在这个前端服务已经跑起来了，接下来你可以完成部署的其它阶段了。</p> <p>一般情况下，以下就成了运维的工作了，不过，拓展自己的知识边界总是没错的。其它阶段介绍如下</p> <ul><li>使用 <code>nginx</code> 或者 <code>traefik</code> 做反向代理。在我内部集群中使用了 <code>traefik</code>，详见 <a href="https://github.com/shfshanyue/op-note/blob/master/traefik.md" target="_blank" rel="noopener noreferrer">traefik 简易入门<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li>使用 <code>kubernetes</code> 或者 <code>docker compose</code> 做容器编排。在我内部集群中使用了 <code>compose</code>，详见 <a href="https://github.com/shfshanyue/op-note/blob/master/traefik-compose.md" target="_blank" rel="noopener noreferrer">docker compose 简易入门<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li>使用 <code>gitlab ci</code>，<code>drone ci</code> 或者 <code>github actions</code> 等做 CI/CD 自动部署。在我内部集群中使用了 <code>github actions</code>，详见 <a href="https://github.com/shfshanyue/op-note/blob/master/github-action-guide.md" target="_blank" rel="noopener noreferrer">github actions 简易入门<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul> <p>这时镜像存在两个问题，导致每次部署时间过长，不利于产品的快速交付，没有快速交付，也就没有敏捷开发 (Agile)</p> <ul><li>构建镜像时间过长</li> <li>构建镜像大小过大，多时甚至 1G+</li></ul> <h2 id="利用镜像缓存"><a href="#利用镜像缓存" class="header-anchor">#</a> 利用镜像缓存</h2> <p>我们注意到，相对于项目的源文件来讲，<code>package.json</code> 是相对稳定的。如果没有新的安装包需要下载，则再次构建镜像时，无需重新构建依赖。则可以在 npm install 上节省一半的时间。</p> <p>对于 <code>ADD</code> 来讲，如果需要添加的文件内容的 <code>checksum</code> 没有发生变化，则可以利用缓存。把 <code>package.json/package-lock.json</code> 与源文件分隔开写入镜像是一个很好的选择。目前，如果没有新的安装包更新的话，可以节省一半时间</p> <div class="language-dockerfile extra-class"><pre class="language-dockerfile"><code><span class="token keyword">FROM</span> node<span class="token punctuation">:</span>10<span class="token punctuation">-</span>alpine

<span class="token keyword">ENV</span> PROJECT_ENV production
<span class="token keyword">ENV</span> NODE_ENV production

<span class="token comment"># http-server 不变动也可以利用缓存</span>
<span class="token keyword">RUN</span> npm install <span class="token punctuation">-</span>g http<span class="token punctuation">-</span>server

<span class="token keyword">WORKDIR</span> /code

<span class="token comment"># 首次添加此两个文件，充分利用缓存</span>
<span class="token keyword">ADD</span> package.json package<span class="token punctuation">-</span>lock.json /code
<span class="token keyword">RUN</span> npm install <span class="token punctuation">-</span><span class="token punctuation">-</span>production

<span class="token keyword">ADD</span> . /code
<span class="token keyword">RUN</span> npm run build
<span class="token keyword">EXPOSE</span> 80

<span class="token keyword">CMD</span> http<span class="token punctuation">-</span>server ./public <span class="token punctuation">-</span>p 80
</code></pre></div><p>关于利用缓存有更多细节，需要特别注意一下。如 <code>RUN git clone &lt;repo&gt;</code>，如果命令字符串没有更新，则将使用缓存，当命令是非幂等性时，这将有可能导致问题。</p> <blockquote><p>关于缓存及可能导致的问题，可以参考我的文章 <a href="https://shanyue.tech/op/dockerfile-practice.html#%E5%85%85%E5%88%86%E5%88%A9%E7%94%A8%E6%9E%84%E5%BB%BA%E7%BC%93%E5%AD%98" target="_blank" rel="noopener noreferrer">Dockerfile 最佳实践<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></blockquote> <h2 id="ci-环境下的优化"><a href="#ci-环境下的优化" class="header-anchor">#</a> CI 环境下的优化</h2> <div class="language-dockerfile extra-class"><pre class="language-dockerfile"><code><span class="token keyword">FROM</span> node<span class="token punctuation">:</span>10<span class="token punctuation">-</span>alpine

<span class="token keyword">ENV</span> PROJECT_ENV production
<span class="token keyword">ENV</span> NODE_ENV production

<span class="token comment"># http-server 不变动也可以利用缓存</span>
<span class="token keyword">RUN</span> npm install <span class="token punctuation">-</span>g http<span class="token punctuation">-</span>server

<span class="token keyword">WORKDIR</span> /code

<span class="token comment"># 首次添加此两个文件，充分利用缓存</span>
<span class="token keyword">ADD</span> package.json package<span class="token punctuation">-</span>lock.json /code
<span class="token keyword">RUN</span> npm ci

<span class="token keyword">ADD</span> . /code
<span class="token keyword">RUN</span> npm run build
<span class="token keyword">EXPOSE</span> 80

<span class="token keyword">CMD</span> http<span class="token punctuation">-</span>server ./public <span class="token punctuation">-</span>p 80
</code></pre></div><p>在 CI 环境下主要做了一点改动：使用 <code>npm ci</code> 代替 <code>npm i</code>，经实验，<code>npm ci</code> 可以减少将近一半的的依赖安装时间。</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token function">npm</span> <span class="token function">install</span>
added <span class="token number">1154</span> packages <span class="token keyword">in</span> 60s

$ <span class="token function">npm</span> ci
added <span class="token number">1154</span> packages <span class="token keyword">in</span> 35s
</code></pre></div><p>另外，当 <code>package.json</code> 与 <code>package-lock.json</code> 版本不匹配时，<code>npm ci</code> 将会报出异常，提前检测出不安全信息，及早发现问题，及早解决问题。</p> <p>关于安装依赖速度的优化，可以参考我以前的文章 <a href="https://shanyue.tech/frontend-engineering/npm-install.html" target="_blank" rel="noopener noreferrer">前端高级进阶：在生产环境中使你的 npm i 速度提升 50%<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h2 id="多阶段构建"><a href="#多阶段构建" class="header-anchor">#</a> 多阶段构建</h2> <p>得益于缓存，现在镜像构建时间已经快了不少。但是，此时镜像的体积依旧过于庞大，这也将会导致部署时间的加长。原因如下</p> <p>考虑下每次 CI/CD 部署的流程</p> <ol><li>在构建服务器 (Runer) 构建镜像</li> <li>把镜像推至镜像仓库服务器</li> <li>在生产服务器拉取镜像，启动容器</li></ol> <p>显而易见，镜像体积过大会在前两步上传及下载时造成传输效率低下，增加每次部署的延时。</p> <p>即使，构建服务器与生产服务器在同一节点下，没有延时的问题 (基本没可能)。减少镜像体积也能够节省磁盘空间。</p> <p>关于镜像体积的过大，完全是因为node_modules 臭名昭著的体积:</p> <p><img src="/assets/img/node_modules.31feb183.jpg" alt="node_modules的体积"></p> <p>但最后我们只需要构建生成的静态资源，对于源文件以及 <code>node_modules</code> 下文件，占用体积过大且不必要，造成浪费。</p> <p>此时可以利用 Docker 的多阶段构建，仅来提取编译后文件，即打包生成的静态资源，对 Dockerfile 做一改进</p> <div class="language-docker extra-class"><pre class="language-docker"><code><span class="token keyword">FROM</span> node<span class="token punctuation">:</span>10<span class="token punctuation">-</span>alpine as builder

<span class="token keyword">ENV</span> PROJECT_ENV production
<span class="token keyword">ENV</span> NODE_ENV production

<span class="token comment"># http-server 不变动也可以利用缓存</span>
<span class="token keyword">WORKDIR</span> /code

<span class="token keyword">ADD</span> package.json package<span class="token punctuation">-</span>lock.json /code
<span class="token keyword">RUN</span> npm ci

<span class="token keyword">ADD</span> . /code
<span class="token keyword">RUN</span> npm run build

<span class="token comment"># 选择更小体积的基础镜像</span>
<span class="token keyword">FROM</span> nginx<span class="token punctuation">:</span>10<span class="token punctuation">-</span>alpine
<span class="token keyword">COPY</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>from=builder /code/public /usr/share/nginx/html
</code></pre></div><p>此时，镜像体积从 1G+ 变成了 50M+。若此时的部署仅仅是在测试环境或者多分支环境下为了方便测试，那就大功告成，完美解决问题了。</p> <h2 id="使用对象存储服务-oss"><a href="#使用对象存储服务-oss" class="header-anchor">#</a> 使用对象存储服务 (OSS)</h2> <p>分析一下 50M+ 的镜像体积，<code>nginx:10-alpine</code> 的镜像是16M，剩下的40M是静态资源。生产环境的静态资源往往会在独立域名上维护，并使用 CDN 进行加速。</p> <p><strong>如果把静态资源给上传到文件存储服务，即OSS，并使用 CDN 对 OSS 进行加速，则没有必要打入镜像了。而在生产环境下也有对静态资源上 CDN 的强烈需求。</strong></p> <p>此时镜像大小会控制在 20M 以下。虽然极大地减小了镜像体积，但是它会增加复杂度与增加镜像构建时间(如上传到OSS)，对于测试环境或者分支环境没必要使用 OSS。</p> <p>关于静态资源，可以分类成两部分：</p> <ul><li><code>/build</code>，此类文件在项目中使用 require/import 引用，会被 webpack 打包并加 hash 值，并通过 publicPath 修改资源地址。可以把此类文件上传至 oss，并加上永久缓存，不需要打入镜像</li> <li><code>/static</code>，此类文件在项目中直接引用根路径，直接打入镜像，如果上传至 OSS 可能增加复杂度 (批量修改 publicPath)</li></ul> <p>此时通过一个脚本命令 <code>npm run uploadOss</code>，来把静态资源上传至 OSS。更新后的 Dockerfile 如下</p> <div class="language-dockerfile extra-class"><pre class="language-dockerfile"><code><span class="token keyword">FROM</span> node<span class="token punctuation">:</span>10<span class="token punctuation">-</span>alpine as builder

<span class="token keyword">ENV</span> PROJECT_ENV production
<span class="token keyword">ENV</span> NODE_ENV production

<span class="token comment"># http-server 不变动也可以利用缓存</span>
<span class="token keyword">WORKDIR</span> /code

<span class="token keyword">ADD</span> package.json package<span class="token punctuation">-</span>lock.json /code
<span class="token keyword">RUN</span> npm ci

<span class="token keyword">ADD</span> . /code

<span class="token comment"># npm run uploadOss 是把静态资源上传至 oss 上的脚本文件</span>
<span class="token keyword">RUN</span> npm run build &amp;&amp; npm run uploadOss

<span class="token comment"># 选择更小体积的基础镜像</span>
<span class="token keyword">FROM</span> nginx<span class="token punctuation">:</span>10<span class="token punctuation">-</span>alpine
<span class="token keyword">COPY</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>from=builder code/public/index.html code/public/favicon.ico /usr/share/nginx/html/
<span class="token keyword">COPY</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>from=builder code/public/static /usr/share/nginx/html/static
</code></pre></div><h2 id="小结"><a href="#小结" class="header-anchor">#</a> 小结</h2> <p>经过本篇文章总结，在前端中构建镜像需要注意以下几点</p> <ol><li>镜像中使用基于 <code>alpine</code> 的镜像，减小镜像体积。</li> <li>镜像中需要锁定 <code>node</code> 的版本号，尽可能也锁定 <code>alpine</code> 的版本号，如 <code>node:10.19-alpine3.11</code>。(我示例代码中未如此详细地指出)</li> <li>选择合适的环境变量 <code>NODE_ENV</code> 及 <code>PROJECT_ENV</code>，如在测试环境下进行构建</li> <li>npm ci 替代 npm i，避免版本问题及提高依赖安装速度</li> <li>package.json 单独添加，充分利用镜像缓存</li> <li>使用多阶段构建，减小镜像体积</li> <li>如有必要，静态资源请上 CDN</li></ol></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">3/1/2021, 1:40:08 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/note/前端工程化/deploy.html" class="prev">
        前端部署的发展历程
      </a></span> <span class="next"><a href="/note/前端工程化/eslint.html">
        团队编码规范约束最佳实践
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.4f4ef6e8.js" defer></script><script src="/assets/js/2.b1de68ec.js" defer></script><script src="/assets/js/36.4a5a45e3.js" defer></script>
  </body>
</html>
