(window.webpackJsonp=window.webpackJsonp||[]).push([[161],{602:function(t,s,e){"use strict";e.r(s);var a=e(40),r=Object(a.a)({},(function(){var t=this,s=t.$createElement,e=t._self._c||s;return e("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[e("h1",{attrs:{id:"部署-postgres"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#部署-postgres"}},[t._v("#")]),t._v(" 部署 postgres")]),t._v(" "),e("p",[e("code",[t._v("postgres")]),t._v(" 是一个功能强大的开源对象关系型数据库系统，被业界誉为“最先进的开源数据库“。")]),t._v(" "),e("p",[e("code",[t._v("postgres")]),t._v(" 不仅功能强大，而且免费开源，你可以在 github 上学习并研究它的源码: "),e("a",{attrs:{href:"https://github.com/postgres/postgres",target:"_blank",rel:"noopener noreferrer"}},[t._v("postgres/postgres"),e("OutboundLink")],1),t._v("。另外，它在数据类型，内置函数，事务的支持相比 "),e("code",[t._v("mysql")]),t._v(" 都要好一些。")]),t._v(" "),e("p",[t._v("但我在个人服务器里选择 "),e("code",[t._v("postgres")]),t._v(" 的终极原因是: 我们生产环境中大部分数据库都采用了 "),e("code",[t._v("postgres")]),t._v("。")]),t._v(" "),e("p",[t._v("关于 "),e("code",[t._v("mysql")]),t._v(" 与 "),e("code",[t._v("postgres")]),t._v(" 的优劣，可以参考知乎上的一个问题: "),e("a",{attrs:{href:"https://www.zhihu.com/question/20010554",target:"_blank",rel:"noopener noreferrer"}},[t._v("PostgreSQL 与 MySQL 相比，优势何在？"),e("OutboundLink")],1),t._v("。")]),t._v(" "),e("h2",{attrs:{id:"部署"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#部署"}},[t._v("#")]),t._v(" 部署")]),t._v(" "),e("p",[t._v("在部署之前，你需要对 "),e("code",[t._v("docker-compose")]),t._v(" 以及 "),e("code",[t._v("traefik")]),t._v(" 有所了解，可以参考我以前的文章:")]),t._v(" "),e("ul",[e("li",[e("a",{attrs:{href:"https://shanyue.tech/op/docker-compose.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("docker compose 简易入门"),e("OutboundLink")],1)]),t._v(" "),e("li",[e("a",{attrs:{href:"https://shanyue.tech/op/traefik.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("使用 traefik 做反向代理"),e("OutboundLink")],1)])]),t._v(" "),e("p",[t._v("这里采用官方镜像 "),e("code",[t._v("postgres:12-alpine")]),t._v(" 进行数据库的部署，之所以采用 "),e("code",[t._v("alpine")]),t._v(" 作为基础镜像，源于它体积较小。")]),t._v(" "),e("p",[t._v("我们使用 "),e("code",[t._v("docker-compose")]),t._v(" 进行数据库的部署， 如果你对它不了解，可以参考我以前写的系列文章 "),e("a",{attrs:{href:"https://github.com/shfshanyue/op-note",target:"_blank",rel:"noopener noreferrer"}},[t._v("个人服务器运维指南"),e("OutboundLink")],1),t._v("。")]),t._v(" "),e("p",[t._v("对于数据库的存储，我放置于当前目录 "),e("code",[t._v("./pg-data")]),t._v(" 之下，方便迁移。关于 "),e("code",[t._v("docker-compose.yaml")]),t._v(" 配置文件如下:")]),t._v(" "),e("blockquote",[e("p",[t._v("关于我个人服务器下所有服务的配置文件，均维护在我的 github 仓库 "),e("a",{attrs:{href:"https://github.com/shfshanyue/op-note/tree/master/compose",target:"_blank",rel:"noopener noreferrer"}},[t._v("shfshanyue/op-note:compose"),e("OutboundLink")],1),t._v(" 中")])]),t._v(" "),e("div",{staticClass:"language-yaml extra-class"},[e("pre",{pre:!0,attrs:{class:"language-yaml"}},[e("code",[e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("version")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'3'")]),t._v("\n\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("services")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("db")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("image")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" postgres"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("12"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("alpine\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("restart")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" always\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("ports")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" 5432"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("5432")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("volumes")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" ./pg"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("data"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("/var/lib/postgresql/data\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("labels")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"traefik.http.routers.db.rule=Host(`db.shanyue.local`)"')]),t._v("\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 使用已存在的 traefik 的 network")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("networks")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("default")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("external")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" traefik_default\n")])])]),e("p",[e("code",[t._v("docker-compose up")]),t._v(" 启动服务，数据库部署完成")]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[t._v("$ docker-compose up -d\n")])])]),e("h2",{attrs:{id:"连接数据库"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#连接数据库"}},[t._v("#")]),t._v(" 连接数据库")]),t._v(" "),e("p",[t._v("使用 "),e("code",[t._v("docker-compose exec")]),t._v(" 测试是否能够正常连接数据库，通过测试，我们已经正确部署并且连接上了数据库")]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[t._v("$ docker-compose "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("exec")]),t._v(" db psql -U postgres\npsql "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("12.1")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\nType "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"help"')]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" help.\n\n"),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("postgres")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#")]),t._v("\n")])])]),e("p",[t._v("在宿主机中可以通过 "),e("code",[t._v("docker-compose")]),t._v(" 与 "),e("code",[t._v("psql")]),t._v(" 来连接数据库，那如何在整个局域网集群中连接数据库呢？")]),t._v(" "),e("h2",{attrs:{id:"使用-pgcli-连接数据库"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#使用-pgcli-连接数据库"}},[t._v("#")]),t._v(" 使用 pgcli 连接数据库")]),t._v(" "),e("p",[t._v("如果把 "),e("code",[t._v("psql")]),t._v(" 比作记事本，那么 "),e("code",[t._v("pgcli")]),t._v(" 则是带有代码高亮功能的 IDE。在日常开发中，使用 "),e("code",[t._v("pgcli")]),t._v(" 足以应付生产环境多个数据库的配置管理。")]),t._v(" "),e("p",[t._v("使用 "),e("code",[t._v("brew")]),t._v(" 安装 "),e("code",[t._v("pgcli")]),t._v(":")]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[t._v("$ brew "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v(" pgcli\n")])])]),e("p",[t._v("使用 "),e("code",[t._v("pgcli")]),t._v(" 得以成功连接数据库:")]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[t._v("$ pgcli -h db.shanyue.local -U postgres\npostgres@db:postgres"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("d\n+----------+--------+--------+---------+\n"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" Schema   "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" Name   "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" Type   "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" Owner   "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("----------+--------+--------+---------"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("\n+----------+--------+--------+---------+\nSELECT "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("\nTime: "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(".030s\n\n")])])])])}),[],!1,null,null,null);s.default=r.exports}}]);