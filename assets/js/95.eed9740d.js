(window.webpackJsonp=window.webpackJsonp||[]).push([[95],{516:function(s,e,t){"use strict";t.r(e);var a=t(40),n=Object(a.a)({},(function(){var s=this,e=s.$createElement,t=s._self._c||e;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h1",{attrs:{id:"使用-serverless-与-next-开发第一个-ssr-应用"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#使用-serverless-与-next-开发第一个-ssr-应用"}},[s._v("#")]),s._v(" 使用 serverless 与 next 开发第一个 SSR 应用")]),s._v(" "),t("p",[s._v("在上一章，我介绍到了 "),t("a",{attrs:{href:"https://shanyue.tech/no-vps/sls-koa.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("如何使用 serverless 部署第一个 koa 应用"),t("OutboundLink")],1),s._v("。对于一个后端(Node)项目使用 "),t("code",[s._v("serverless")]),s._v(" 的方式要接收巨大的挑战，其中最大的挑战来自于传统的并已完善与成熟的架构。")]),s._v(" "),t("p",[s._v("而对于一个弱存储弱状态的 SSR 项目或者纯前端项目，通过 "),t("code",[s._v("zeit")]),s._v(" 或者 "),t("code",[s._v("netlify")]),s._v(" 部署是一个更好的选择，然而由于网络原因并不适用于国内。国内也无如 "),t("code",[s._v("netlify")]),s._v(" 一样的前端快速部署方案（笔者认为这一点对于国内的云服务商是一个可选的机会），此时 "),t("code",[s._v("serverless")]),s._v(" 是一个不错的选择，只需一行命令即可充分利用缓存配置，对象存储服务，CDN 与自动 https 证书。")]),s._v(" "),t("p",[s._v("本篇文章介绍如何使用 serverlss 开发第一个 SSR 应用。SSR，即 "),t("code",[s._v("Server Side Render")]),s._v("，服务端渲染为单页应用的 SEO 提供了一种更好的体验，同时，他对首屏优化也有极大提升。而 "),t("code",[s._v("Next.js")]),s._v(" 无疑是服务端渲染框架中最璀璨的明珠。")]),s._v(" "),t("p",[s._v("这里是一个结合 "),t("code",[s._v("ts")]),s._v(" 及 `` 快速部署到腾讯云函数计算中的模板。仓库见下")]),s._v(" "),t("ul",[t("li",[t("a",{attrs:{href:"https://github.com/shfshanyue/serverless-template-zh",target:"_blank",rel:"noopener noreferrer"}},[s._v("shfshanyue/serverless-template-zh"),t("OutboundLink")],1),s._v(": 中国云厂商 serverless framework 模板及示例 （更快的访问速度）")])]),s._v(" "),t("h2",{attrs:{id:"快速使用"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#快速使用"}},[s._v("#")]),s._v(" 快速使用")]),s._v(" "),t("p",[s._v("使用本模板快速创建应用")]),s._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("$ serverless "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" --url https://github.com/shfshanyue/serverless-template-zh/tree/master/tencent-next-helmet-ga --name next-app\n")])])]),t("p",[s._v("在项目创建早期尽可能对 package 进行升级，这里使用了 "),t("code",[s._v("npm-check-updates")])]),s._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("$ "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("npm")]),s._v(" run ncu\n")])])]),t("p",[s._v("在测试环境中进行开发")]),s._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("$ "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("npm")]),s._v(" run dev\n")])])]),t("h3",{attrs:{id:"文件结构"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#文件结构"}},[s._v("#")]),s._v(" 文件结构")]),s._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(".")]),s._v("\n├── node_modules/\n├── pages/                  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 所有的 pages")]),s._v("\n├── utils/\n├── package.json\n├── package-lock.json\n├── README.md\n└── serverless.yaml\n")])])]),t("h3",{attrs:{id:"serverless-component"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#serverless-component"}},[s._v("#")]),s._v(" serverless component")]),s._v(" "),t("p",[t("code",[s._v("serverless component")]),s._v(" 可以认为是把 faas 及 baas 资源集合的进一步抽象，该项目采用了 "),t("code",[s._v("@serverless/tencent-next")])]),s._v(" "),t("div",{staticClass:"language-yaml extra-class"},[t("pre",{pre:!0,attrs:{class:"language-yaml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("next-app")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("component")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'@serverless/tencent-nextjs'")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("inputs")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("functionName")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" nextjs"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("function\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("region")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" ap"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("guangzhou\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("runtime")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Nodejs10.15\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("code")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" ./\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("functionConf")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("timeout")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("60")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("memorySize")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("128")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("environment")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("variables")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("ENV")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token boolean important"}},[s._v("true")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apigatewayConf")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("protocols")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" http\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" https\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("environment")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" release\n")])])]),t("h2",{attrs:{id:"部署"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#部署"}},[s._v("#")]),s._v(" 部署")]),s._v(" "),t("p",[s._v("部署之前需要准备好生产环境所需的 "),t("code",[s._v("node_modules")]),s._v(" 以及编译完成的 js 资源。")]),s._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 编译静态文件")]),s._v("\n$ "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("npm")]),s._v(" run build\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 部署到腾讯云")]),s._v("\n$ sls\n next-app:\n    functionName:        nextjs-function\n    functionOutputs:\n      ap-guangzhou:\n        Name:        nextjs-function\n        Runtime:     Nodejs10.15\n        Handler:     serverless-handler.handler\n        MemorySize:  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("128")]),s._v("\n        Timeout:     "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("60")]),s._v("\n        Region:      ap-guangzhou\n        Namespace:   default\n        Description: This is a "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("function")]),s._v(" created by serverless component\n    region:              ap-guangzhou\n    apiGatewayServiceId: service-r8i140rq\n    url:                 https://service-r8i140rq-1257314149.gz.apigw.tencentcs.com/release/\n    cns:                 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("empty array"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n  240s › next-app › "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("done")]),s._v("\n")])])]),t("p",[s._v("此时网站部署在了 "),t("code",[s._v("https://service-r8i140rq-1257314149.gz.apigw.tencentcs.com/release/")]),s._v("，可通过访问连接直接查看效果")]),s._v(" "),t("p",[s._v("从日志可以看出，部署到腾讯云需要使用 4 分钟，而且这仅仅是一个 "),t("code",[s._v("hello, world")]),s._v("，不过现在国内的 serverless 还处于早期发展状态，这将在不久得到优化。")]),s._v(" "),t("p",[s._v("如果对于部署速度有所追求的话，可以使用 "),t("code",[s._v("now.sh")]),s._v("，仅需要 3s 就可以部署成功，"),t("code",[s._v("now")]),s._v(" 以及 "),t("code",[s._v("next")]),s._v(" 均处于一家公司旗下，对于 "),t("code",[s._v("next")]),s._v(" 的部署有很大程度的优化。")]),s._v(" "),t("h2",{attrs:{id:"缺点"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#缺点"}},[s._v("#")]),s._v(" 缺点")]),s._v(" "),t("p",[s._v("这里是使用腾讯云目前部署 "),t("code",[s._v("serverless")]),s._v(" 的一些缺点")]),s._v(" "),t("ol",[t("li",[s._v("部署过慢，node_modules 过大，导致上传时间过长")]),s._v(" "),t("li",[s._v("对于 SSR 项目，所有的静态资源相关的依赖可视为 devDep，对于这类库可以不上传，目前是全部上传，这也是部署过慢的原因")]),s._v(" "),t("li",[s._v("在本地不支持 "),t("code",[s._v("log")]),s._v(" 及 "),t("code",[s._v("metrics")]),s._v("，需要转至腾讯云控制台查看")])])])}),[],!1,null,null,null);e.default=n.exports}}]);