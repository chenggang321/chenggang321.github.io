(window.webpackJsonp=window.webpackJsonp||[]).push([[82],{493:function(t,e,s){"use strict";s.r(e);var a=s(40),r=Object(a.a)({},(function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("p",[t._v("metrics server 用以监控k8s集群中每个 pod 与 node 的 CPU/Memory 使用情况。另外，正因为它能够监控 CPU/Memory 它也被用作弹性扩容。")]),t._v(" "),s("p",[s("img",{attrs:{src:"",alt:"集群监控情况"}})]),t._v(" "),s("h2",{attrs:{id:"参考"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#参考"}},[t._v("#")]),t._v(" 参考")]),t._v(" "),s("p",[t._v("先上两篇官方文档作为参考，强烈建议阅读第二篇")]),t._v(" "),s("ol",[s("li",[s("a",{attrs:{href:"https://kubernetes.io/docs/tasks/debug-application-cluster/resource-metrics-pipeline/",target:"_blank",rel:"noopener noreferrer"}},[t._v("Resource metrics pipeline"),s("OutboundLink")],1)]),t._v(" "),s("li",[s("a",{attrs:{href:"https://github.com/kubernetes/community/blob/master/contributors/design-proposals/instrumentation/monitoring_architecture.md",target:"_blank",rel:"noopener noreferrer"}},[t._v("Kubernetes monitoring architecture"),s("OutboundLink")],1)])]),t._v(" "),s("p",[t._v("这里有一张从第二篇文章中抽出来的监控架构图")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://raw.githubusercontent.com/kubernetes/community/master/contributors/design-proposals/instrumentation/monitoring_architecture.png",alt:"monitoring architecture"}})]),t._v(" "),s("h2",{attrs:{id:"部署"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#部署"}},[t._v("#")]),t._v(" 部署")]),t._v(" "),s("p",[t._v("可以直接使用官方写好的配置文件进行部署: "),s("a",{attrs:{href:"https://github.com/kubernetes-incubator/metrics-server",target:"_blank",rel:"noopener noreferrer"}},[t._v("kubernetes-incubator/metrics-server"),s("OutboundLink")],1)]),t._v(" "),s("blockquote",[s("p",[t._v("这里也有一个镜像需要在代理节点下载并使用 rsync 移动到 work node："),s("code",[t._v("k8s.gcr.io/metrics-server-amd64:v0.3.6")]),t._v("。详细方法参照 [](kubectl create -f deploy/1.8+/)\n如果采用代理节点下载并移动的方案进行部署，则需要设置 image 的 "),s("code",[t._v("imagePullPolicy: IfNotPresent")])])]),t._v(" "),s("p",[t._v("以下是关于 metrics server 的安装步骤")]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[t._v("$ "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("git")]),t._v(" clone git@github.com:kubernetes-incubator/metrics-server.git\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 切换至 v0.3.6 版本")]),t._v("\n$ "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("cd")]),t._v(" metrics-server "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("git")]),t._v(" checkout v0.3.6\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 创建资源，注意在此之前拉取镜像需要设置代理，或者在代理机上准备好并复制过来")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 再要注意，如果使用代理节点下载并且复制的方案进行部署，需要删除  metrics-server-deployment.yaml 中关于 imagePullPolicy 的一行")]),t._v("\n$ "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("sed")]),t._v(" -i "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'/imagePullPolicy: Always/d'")]),t._v(" deploy/1.8+/metrics-server-deployment.yaml\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 添加两个参数")]),t._v("\n$ "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("sed")]),t._v(" -i "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('\'/image: k8s.gcr.io/a \\        args: [ "--kubelet-insecure-tls", "--kubelet-preferred-address-types=InternalIP"]\'')]),t._v(" deploy/1.8+/metrics-server-deployment.yaml\n\n$ kubectl apply -f deploy/1.8+/\nclusterrole.rbac.authorization.k8s.io/system:aggregated-metrics-reader created\nclusterrolebinding.rbac.authorization.k8s.io/metrics-server:system:auth-delegator created\nrolebinding.rbac.authorization.k8s.io/metrics-server-auth-reader created\napiservice.apiregistration.k8s.io/v1beta1.metrics.k8s.io created\nserviceaccount/metrics-server created\ndeployment.extensions/metrics-server created\nservice/metrics-server created\nclusterrole.rbac.authorization.k8s.io/system:metrics-server created\nclusterrolebinding.rbac.authorization.k8s.io/system:metrics-server created\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 获取所有 pod，查看 metrc-server 此时处于运行状态")]),t._v("\n$ kubectl get pods --all-namespaces "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("grep")]),t._v(" metrics\nkube-system   metrics-server-7fbb854b45-zsc5s                  "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("/1     Running   "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("          64s\n")])])]),s("p",[t._v("部署成功后，可以使用 "),s("code",[t._v("kubectl top nodes")])]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[t._v("$ kubectl "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("top")]),t._v(" nodes\nNAME       CPU"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("cores"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("   CPU%   MEMORY"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("bytes"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("   MEMORY%\nshanyue    114m         "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("5")]),t._v("%     2327Mi          "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("63")]),t._v("%\nshuifeng   32m          "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("%     2379Mi          "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("15")]),t._v("%\n")])])]),s("h3",{attrs:{id:"error-metrics-not-available-yet"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#error-metrics-not-available-yet"}},[t._v("#")]),t._v(" error: metrics not available yet")]),t._v(" "),s("p",[t._v("部署过程有可能出现错误 "),s("code",[t._v("error: metrics not available yet")]),t._v("，可以参考该 "),s("a",{attrs:{href:"https://github.com/kubernetes-incubator/metrics-server/issues/247",target:"_blank",rel:"noopener noreferrer"}},[t._v("Issue"),s("OutboundLink")],1)]),t._v(" "),s("p",[t._v("此时可以添加两个参数 "),s("code",[t._v("--kubelet-insecure-tls")]),t._v(" 和 "),s("code",[t._v("--kubelet-preferred-address-types=InternalIP")]),t._v(" 来避免问题")]),t._v(" "),s("div",{staticClass:"language-yaml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-yaml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("spec")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("selector")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n   "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("matchLabels")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n     "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("k8s-app")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" metrics"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("server\n "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("template")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n   "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("metadata")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n     "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" metrics"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("server\n     "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("labels")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n       "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("k8s-app")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" metrics"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("server\n   "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("spec")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n     "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("serviceAccountName")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" metrics"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("server\n     "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("volumes")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n     "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" tmp"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("dir\n       "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("emptyDir")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n     "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("containers")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n     "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" metrics"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("server\n       "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("image")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" k8s.gcr.io/metrics"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("server"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("amd64"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("v0.3.6\n       "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 添加两个参数避免此类问题")]),t._v("\n       "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("args")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"--kubelet-insecure-tls"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"--kubelet-preferred-address-types=InternalIP"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n       "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("volumeMounts")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n       "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" tmp"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("dir\n         "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("mountPath")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" /tmp\n")])])]),s("p",[t._v("可以直接使用 "),s("code",[t._v("sed")]),t._v(" 命令直接修改文件，关于 sed 可以参考 "),s("a",{attrs:{href:"https://shanyue.tech/op/linux-sed.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("sed 命令详解"),s("OutboundLink")],1)]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# -i 代表直接替换文件")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# a 代表下一行插入 (i 代表上一行插入)")]),t._v("\n$ "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("sed")]),t._v(" -i "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('\'/image: k8s.gcr.io/a \\        args: [ "--kubelet-insecure-tls", "--kubelet-preferred-address-types=InternalIP"]\'')]),t._v(" deploy/1.8+/metrics-server-deployment.yaml\n")])])])])}),[],!1,null,null,null);e.default=r.exports}}]);