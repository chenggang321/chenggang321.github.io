(window.webpackJsonp=window.webpackJsonp||[]).push([[181],{627:function(t,a,s){"use strict";s.r(a);var e=s(40),n=Object(e.a)({},(function(){var t=this,a=t.$createElement,s=t._self._c||a;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h1",{attrs:{id:"在-traefik-中为服务开通-https"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#在-traefik-中为服务开通-https"}},[t._v("#")]),t._v(" 在 traefik 中为服务开通 https")]),t._v(" "),s("p",[s("code",[t._v("https")]),t._v(" 已经成为一个现代网站的标配，以至于当一个网站没有 "),s("code",[t._v("https")]),t._v(" 时，某些浏览器都会把它标识为不安全。而除了安全方面，"),s("code",[t._v("https")]),t._v(" 对网站的SEO也影响很多，而对于某些新型的浏览器 API，也只有在 "),s("code",[t._v("https")]),t._v(" 下才能使用。不管怎么说，"),s("code",[t._v("https")]),t._v(" 也成为一个网站的刚需。")]),t._v(" "),s("p",[t._v("而当你使用了 "),s("code",[t._v("traefik")]),t._v(" 作为反向代理时，你可以配置 "),s("code",[t._v("ACME")]),t._v(" 自动为域名提供证书，只需几行即可解决问题。免费的证书，当然是通过 "),s("code",[t._v("Let's Encrypt")]),t._v(" 来解决。")]),t._v(" "),s("h2",{attrs:{id:"acme-配置"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#acme-配置"}},[t._v("#")]),t._v(" ACME 配置")]),t._v(" "),s("p",[t._v("通过它可以很方便地自动签发证书并且自动续期，我们在 "),s("code",[t._v("traefik.toml")]),t._v(" 中进行相关配置")]),t._v(" "),s("div",{staticClass:"language-toml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-toml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token table class-name"}},[t._v("certificatesResolvers.le.acme")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key property"}},[t._v("email")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"xianger94@qq.com"')]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key property"}},[t._v("storage")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"acme.json"')]),t._v("\n\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token table class-name"}},[t._v("certificatesResolvers.le.acme.tlsChallenge")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n")])])]),s("p",[t._v("其中，"),s("code",[t._v("storage")]),t._v(" 指存放证书的位置")]),t._v(" "),s("h2",{attrs:{id:"traefik-容器配置"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#traefik-容器配置"}},[t._v("#")]),t._v(" Traefik 容器配置")]),t._v(" "),s("p",[t._v("在配置好 "),s("code",[t._v("traefik.toml")]),t._v(" 配置完成后，我们需要修改 "),s("code",[t._v("traefik")]),t._v(" 容器启动的相关配置")]),t._v(" "),s("ol",[s("li",[t._v("暴露 443 端口")]),t._v(" "),s("li",[t._v("挂载 acme.json，持久化证书")])]),t._v(" "),s("p",[t._v("由于 "),s("code",[t._v("acme.json")]),t._v(" 是一个文件，我们现在宿主机中创建它")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[t._v("$ "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("touch")]),t._v(" acme.json\n$ docker-compose up\n")])])]),s("p",[t._v("随后启动容器，配置文件如下")]),t._v(" "),s("div",{staticClass:"language-yaml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-yaml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("version")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'3'")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("services")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("reverse-proxy")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("image")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" traefik"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("v2.0\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("ports")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"80:80"')]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"443:443"')]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"8080:8080"')]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("volumes")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" ./traefik.toml"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("/etc/traefik/traefik.toml\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" ./acme.json"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("/acme.json\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" ./log"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("/log\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" /var/run/docker.sock"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("/var/run/docker.sock\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("container_name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" traefik\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("env_file")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" .env\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("labels")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"traefik.http.routers.api.rule=Host(`traefik.shanyue.local`)"')]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"traefik.http.routers.api.service=api@internal"')]),t._v("\n")])])]),s("h2",{attrs:{id:"服务配置"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#服务配置"}},[t._v("#")]),t._v(" 服务配置")]),t._v(" "),s("p",[t._v("如果你需要为你的服务提供 https 流量，只需要添加两行代码")]),t._v(" "),s("div",{staticClass:"language-yaml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-yaml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("labels")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" traefik.http.routers.whoami.tls=true\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" traefik.http.routers.whoami.tls.certresolver=le\n")])])]),s("p",[t._v("我们依然使用 "),s("code",[t._v("whoami")]),t._v(" 做测试，"),s("code",[t._v("docker-compose.yaml")]),t._v(" 文件内容如下")]),t._v(" "),s("div",{staticClass:"language-yaml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-yaml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("version")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'3'")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("services")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("whoami")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("image")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" containous/whoami\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("labels")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" traefik.http.routers.whoami.rule=Host(`whoami.shanyue.tech`)\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" traefik.http.routers.whoami.tls=true\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" traefik.http.routers.whoami.tls.certresolver=le\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# environments:")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#   TMUX")]),t._v("\n    \n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("networks")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("default")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("external")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" traefik_default\n")])])]),s("p",[t._v("服务启动后，使用 "),s("code",[t._v("curl")]),t._v(" 测试服务是否正常工作，我们可以看到 "),s("code",[t._v("X-Forwarded-Proto")]),t._v(" 为 "),s("code",[t._v("https")]),t._v("，配置成功")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[t._v("$ "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("curl")]),t._v(" https://whoami.shanyue.tech\nHostname: c9c3cc850e2b\nIP: "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("127.0")]),t._v(".0.1\nIP: "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("172.18")]),t._v(".0.2\nRemoteAddr: "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("172.18")]),t._v(".0.3:35320\nGET / HTTP/1.1\nHost: whoami.shanyue.tech\nUser-Agent: curl/7.29.0\nAccept: */*\nAccept-Encoding: "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("gzip")]),t._v("\nX-Forwarded-For: "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("59.110")]),t._v(".159.217\nX-Forwarded-Host: whoami.shanyue.tech\nX-Forwarded-Port: "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("443")]),t._v("\nX-Forwarded-Proto: https\nX-Forwarded-Server: 9d783174aca9\nX-Real-Ip: "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("59.110")]),t._v(".159.217\n")])])])])}),[],!1,null,null,null);a.default=n.exports}}]);