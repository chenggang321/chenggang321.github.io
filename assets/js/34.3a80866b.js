(window.webpackJsonp=window.webpackJsonp||[]).push([[34],{407:function(s,t,a){s.exports=a.p+"assets/img/htop-pid.4e3b1a58.png"},541:function(s,t,a){"use strict";a.r(t);var n=a(40),e=Object(n.a)({},(function(){var s=this,t=s.$createElement,n=s._self._c||t;return n("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[n("p",[s._v("date: 2020-07-02 20:00")]),s._v(" "),n("hr"),s._v(" "),n("h1",{attrs:{id:"如何监控-node-进程的内存"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#如何监控-node-进程的内存"}},[s._v("#")]),s._v(" 如何监控 Node 进程的内存")]),s._v(" "),n("p",[s._v("刚开始，先抛出一个问题：")]),s._v(" "),n("blockquote",[n("p",[s._v("你知道你们生产环境的 Node 服务平时占用内存多少吗？或者说是多少量级？")])]),s._v(" "),n("p",[s._v("山月在面试 Node 候选人时，这个问题足够筛掉一半的自称Node精通者，不过没有回答上来，我往往会再补充一个问题，以免漏掉优秀的无线上经验的候选人：")]),s._v(" "),n("blockquote",[n("p",[n("a",{attrs:{href:"https://q.shanyue.tech/base/linux/4.html#%E6%80%BB%E7%BB%93",target:"_blank",rel:"noopener noreferrer"}},[s._v("如何知道某个进程消耗多少内存？"),n("OutboundLink")],1)])]),s._v(" "),n("p",[n("strong",[s._v("当使用 Node 在生产环境作为服务器语言时，并发量过大或者代码问题造成 OOM (out of memory) 或者 CPU 满载这些都是服务器中常见的问题，此时通过监控 CPU 及内存，再结合日志及 Release 就很容易发现问题。")])]),s._v(" "),n("p",[s._v("本章将介绍如何监控本地环境及生产环境的内存变化")]),s._v(" "),n("h2",{attrs:{id:"一个-node-应用实例"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#一个-node-应用实例"}},[s._v("#")]),s._v(" 一个 Node 应用实例")]),s._v(" "),n("p",[s._v("所以，如何动态监控一个 Node 进程的内存变化呢？")]),s._v(" "),n("p",[s._v("以下是一个 Node Server 的示例，并且是一个有内存泄漏问题的示例，并且是山月在生产环境定位了很久的问题的精简版。")]),s._v(" "),n("blockquote",[n("p",[s._v("那次内存泄漏问题中，导致单个容器中的内存从原先的 400M 暴涨到 700M，在 800M 的容器资源限制下偶尔会发生 OOM，导致重启。一时没有定位到问题 (发现问题过迟，半个月前的时序数据已被吞没，于是未定位到 Release)，于是把资源限制上调到 1000M。后发现是由 ctx.request 挂载了数据库某个大字段而致")])]),s._v(" "),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" Koa "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("require")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'koa'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" app "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Koa")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("function")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("getData")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" Array"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("from")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("Array")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1000")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("map")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token parameter"}},[s._v("x")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=>")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("10086")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\napp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("use")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("async")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token parameter"}},[s._v("ctx"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" next")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=>")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  ctx"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("data "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("getData")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("await")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("next")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\napp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("use")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token parameter"}},[s._v("ctx")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=>")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  ctx"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("body "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'hello, world'")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\napp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("listen")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("3200")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=>")]),s._v(" console"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'Port: 3200'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])])]),n("h2",{attrs:{id:"进程内存监控"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#进程内存监控"}},[s._v("#")]),s._v(" 进程内存监控")]),s._v(" "),n("p",[s._v("一些问题需要在本地及测试环境得到及时扼杀，来避免在生产环境造成更大的影响。那么了解在本地如何监控内存就至关重要。")]),s._v(" "),n("p",[n("code",[s._v("pidstat")]),s._v(" 是 "),n("code",[s._v("sysstat")]),s._v(" 系列 linux 性能调试工具的一个包，竟然用它来调试 linux 的性能问题，包括内存，网络，IO，CPU 等。")]),s._v(" "),n("p",[n("strong",[s._v("这不仅试用与 "),n("code",[s._v("node")]),s._v("，而且适用于一切进程，包括 "),n("code",[s._v("python")]),s._v("，"),n("code",[s._v("java")]),s._v(" 以及 "),n("code",[s._v("go")])])]),s._v(" "),n("div",{staticClass:"language-bash extra-class"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# -r: 指输出内存指标")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# -p: 指定 pid")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 1: 每一秒输出一次")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 100: 输出100次")]),s._v("\n$ pidstat -r -p pid "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),s._v("\n")])])]),n("p",[s._v("而在使用 "),n("code",[s._v("pidstat")]),s._v(" 之前，需要先找到进程的 "),n("code",[s._v("pid")])]),s._v(" "),n("h3",{attrs:{id:"如何找到-node-进程的-pid"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#如何找到-node-进程的-pid"}},[s._v("#")]),s._v(" 如何找到 Node 进程的 pid")]),s._v(" "),n("p",[s._v("在 "),n("code",[s._v("node")]),s._v(" 中可以通过 "),n("code",[s._v("process.pid")]),s._v(" 来找到进程的 "),n("code",[s._v("pid")])]),s._v(" "),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" process"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("pid\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("16425")]),s._v("\n")])])]),n("p",[s._v("虽然通过写代码可以找到 "),n("code",[s._v("pid")]),s._v("，但是具有侵入性，不太实用。那如何通过非侵入的手段找到 "),n("code",[s._v("pid")]),s._v(" 呢？有两种办法")]),s._v(" "),n("ol",[n("li",[s._v("通过多余的参数结合 "),n("code",[s._v("ps")]),s._v(" 定位进程")]),s._v(" "),n("li",[s._v("通过端口号结合 "),n("code",[s._v("lsof")]),s._v(" 定位进程")])]),s._v(" "),n("div",{staticClass:"language-bash extra-class"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[s._v("$ node index.js shanyue\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 第一种方法：通过多余的参数快速定位 pid")]),s._v("\n$ "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ps")]),s._v(" -ef "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" shanyue\nroot     "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("31796")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("23839")]),s._v("  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("16")]),s._v(":38 pts/5    00:00:00 node index.js shanyue\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 第二种方法：通过端口号定位 pid")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("lsof")]),s._v(" -i:3200\nCOMMAND   PID "),n("span",{pre:!0,attrs:{class:"token environment constant"}},[s._v("USER")]),s._v("   FD   TYPE    DEVICE SIZE/OFF NODE NAME\nnode    "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("31796")]),s._v(" root   20u  IPv6 "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("235987334")]),s._v("      0t0  TCP *:tick-port "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("LISTEN"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])])]),n("h2",{attrs:{id:"使用-pidstat-监控内存"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#使用-pidstat-监控内存"}},[s._v("#")]),s._v(" 使用 pidstat 监控内存")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://camo.githubusercontent.com/4e63aceeef7797e78a5f4528478c7a30458dbca2/687474703a2f2f7777772e6272656e64616e67726567672e636f6d2f506572662f6c696e75785f706572665f746f6f6c735f66756c6c2e706e67",alt:""}})]),s._v(" "),n("p",[s._v("从以上代码中可以知道，node 服务的 pid 为 "),n("code",[s._v("31796")]),s._v("，为了可以观察到内存的动态变化，再施加一个压力测试")]),s._v(" "),n("div",{staticClass:"language-bash extra-class"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[s._v("$ ab -c "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("10000")]),s._v(" -n "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1000000")]),s._v(" http://localhost:3200/\n")])])]),n("div",{staticClass:"language-bash extra-class"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# -r: 指输出内存指标")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# -p: 指定 pid")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 1: 每一秒输出一次")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 100: 输出100次")]),s._v("\n$ pidstat -r -p "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("31796")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),s._v("\nLinux "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("3.10")]),s._v(".0-957.21.3.el7.x86_64 "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("shuifeng"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("     "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2020")]),s._v("年07月02日  _x86_64_        "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" CPU"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n             "),n("span",{pre:!0,attrs:{class:"token environment constant"}},[s._v("UID")]),s._v("       PID  minflt/s  majflt/s     VSZ    RSS   %MEM  Command\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("19")]),s._v("时20分39秒     "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("     "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("11401")]),s._v("      "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.00")]),s._v("      "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.00")]),s._v("  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("566768")]),s._v("  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("19800")]),s._v("   "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.12")]),s._v("  node\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("19")]),s._v("时20分40秒     "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("     "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("11401")]),s._v("      "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.00")]),s._v("      "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.00")]),s._v("  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("566768")]),s._v("  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("19800")]),s._v("   "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.12")]),s._v("  node\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("19")]),s._v("时20分41秒     "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("     "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("11401")]),s._v("   "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("9667.00")]),s._v("      "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.00")]),s._v("  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("579024")]),s._v("  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("37792")]),s._v("   "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.23")]),s._v("  node\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("19")]),s._v("时20分42秒     "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("     "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("11401")]),s._v("  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("11311.00")]),s._v("      "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.00")]),s._v("  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("600716")]),s._v("  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("59988")]),s._v("   "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.37")]),s._v("  node\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("19")]),s._v("时20分43秒     "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("     "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("11401")]),s._v("   "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("5417.82")]),s._v("      "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.00")]),s._v("  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("611420")]),s._v("  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("70900")]),s._v("   "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.44")]),s._v("  node\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("19")]),s._v("时20分44秒     "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("     "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("11401")]),s._v("   "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("3901.00")]),s._v("      "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.00")]),s._v("  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("627292")]),s._v("  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("85928")]),s._v("   "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.53")]),s._v("  node\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("19")]),s._v("时20分45秒     "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("     "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("11401")]),s._v("   "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1560.00")]),s._v("      "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.00")]),s._v("  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("621660")]),s._v("  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("81208")]),s._v("   "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.50")]),s._v("  node\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("19")]),s._v("时20分46秒     "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("     "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("11401")]),s._v("   "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2390.00")]),s._v("      "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.00")]),s._v("  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("623964")]),s._v("  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("83696")]),s._v("   "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.51")]),s._v("  node\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("19")]),s._v("时20分47秒     "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("     "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("11401")]),s._v("   "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1764.00")]),s._v("      "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.00")]),s._v("  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("625500")]),s._v("  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("85204")]),s._v("   "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.52")]),s._v("  node\n")])])]),n("p",[s._v("对于输出指标的含义如下")]),s._v(" "),n("ul",[n("li",[n("code",[s._v("RSS")]),s._v(": "),n("code",[s._v("Resident Set Size")]),s._v("，常驻内存集，可理解为内存，这就是我们需要监控的内存指标")]),s._v(" "),n("li",[n("code",[s._v("VSZ")]),s._v(": "),n("code",[s._v("virtual size")]),s._v("，虚拟内存")])]),s._v(" "),n("p",[s._v("从输出可以看出，"),n("strong",[s._v("当施加了压力测试后，内存由 19M 涨到了 85M。")])]),s._v(" "),n("h2",{attrs:{id:"使用-top-监控内存"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#使用-top-监控内存"}},[s._v("#")]),s._v(" 使用 top 监控内存")]),s._v(" "),n("p",[n("code",[s._v("pidstat")]),s._v(" 是属于 "),n("code",[s._v("sysstat")]),s._v(" 下的 linux 性能工具，但在 mac 中，如何定位内存的变化？")]),s._v(" "),n("p",[s._v("此时可以使用 "),n("code",[s._v("top/htop")])]),s._v(" "),n("div",{staticClass:"language-bash extra-class"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[s._v("$ "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("htop")]),s._v(" -p "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("31796")]),s._v("\n")])])]),n("p",[n("img",{attrs:{src:a(407),alt:"使用 htop 监控内存"}})]),s._v(" "),n("h2",{attrs:{id:"内存监控原理"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#内存监控原理"}},[s._v("#")]),s._v(" 内存监控原理")]),s._v(" "),n("p",[s._v("无论使用 "),n("code",[s._v("top/htop")]),s._v("，"),n("code",[s._v("pidstat")]),s._v(" 及 "),n("code",[s._v("process.memoryUsage")]),s._v(" 监控 Node 进程的内存，在 "),n("code",[s._v("linux")]),s._v(" 中，其原理都是监听 "),n("code",[s._v("procfs")]),s._v(" 文件变化")]),s._v(" "),n("ul",[n("li",[n("code",[s._v("cat /proc/100/stat")]),s._v(": 100 号进程的信息，以机器读的格式输出")]),s._v(" "),n("li",[n("code",[s._v("cat /proc/100/status")]),s._v(": 100 好进程的信息，以可读的格式输出")])]),s._v(" "),n("div",{staticClass:"language-bash extra-class"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# machine-readable")]),s._v("\n$ "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" /proc/100/stat\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("kauditd"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" S "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" -1 "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2105408")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("3455")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("63")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("18446744073709551615")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2147483647")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("18446744072255378100")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("17")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# human-readable")]),s._v("\n$ "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" /proc/100/status\nName:   kauditd\nUmask:  0000\nState:  S "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("sleeping"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nTgid:   "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),s._v("\nNgid:   "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\nPid:    "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),s._v("\nPPid:   "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("\nTracerPid:      "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\nUid:    "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("       "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("       "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("       "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\nGid:    "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("       "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("       "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("       "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\nFDSize: "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("64")]),s._v("\nGroups:\nThreads:        "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\nSigQ:   "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("/63460\nSigPnd: 0000000000000000\nShdPnd: 0000000000000000\nSigBlk: 0000000000000000\nSigIgn: ffffffffffffffff\nSigCgt: 0000000000000000\nCapInh: 0000000000000000\nCapPrm: 0000001fffffffff\nCapEff: 0000001fffffffff\nCapBnd: 0000001fffffffff\nCapAmb: 0000000000000000\nSeccomp:        "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\nSpeculation_Store_Bypass:       vulnerable\nCpus_allowed:   "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("\nCpus_allowed_list:      "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("-1\nMems_allowed:   00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000001\nMems_allowed_list:      "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\nvoluntary_ctxt_switches:        "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2353755")]),s._v("\nnonvoluntary_ctxt_switches:     "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("26")]),s._v("\n")])])]),n("h2",{attrs:{id:"生产环境内存监控"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#生产环境内存监控"}},[s._v("#")]),s._v(" 生产环境内存监控")]),s._v(" "),n("p",[s._v("由于目前生产环境大都部署在 "),n("code",[s._v("k8s")]),s._v("，"),n("strong",[s._v("因此生产环境对于某个应用的内存监控本质上是 k8s 对于某个 "),n("code",[s._v("workload/deployment")]),s._v(" 的内存监控")]),s._v("，关于内存监控 "),n("code",[s._v("metric")]),s._v(" 的数据流向大致如下:")]),s._v(" "),n("p",[n("code",[s._v("k8s")]),s._v(" -> "),n("code",[s._v("metric server")]),s._v(" -> "),n("code",[s._v("prometheus")]),s._v(" -> "),n("code",[s._v("grafana")])]),s._v(" "),n("p",[s._v("架构图如下：")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://camo.githubusercontent.com/371929b70ccb8f3b38410047586143399a60bb6d/68747470733a2f2f34373868356d3179726673613362626532363275376d75762d7770656e67696e652e6e6574646e612d73736c2e636f6d2f77702d636f6e74656e742f75706c6f6164732f323031382f30382f70726f6d6574686575735f6b756265726e657465735f6469616772616d5f6f766572766965772e706e67",alt:""}})]),s._v(" "),n("p",[n("img",{attrs:{src:"https://raw.githubusercontent.com/kubernetes/community/master/contributors/design-proposals/instrumentation/monitoring_architecture.png",alt:""}})]),s._v(" "),n("blockquote",[n("p",[s._v("以上图片取自以下文章")]),s._v(" "),n("ul",[n("li",[n("a",{attrs:{href:"https://sysdig.com/blog/kubernetes-monitoring-prometheus/",target:"_blank",rel:"noopener noreferrer"}},[s._v("Kubernetes Monitoring with Prometheus"),n("OutboundLink")],1)]),s._v(" "),n("li",[n("a",{attrs:{href:"https://github.com/kubernetes/community/blob/master/contributors/design-proposals/instrumentation/monitoring_architecture.md",target:"_blank",rel:"noopener noreferrer"}},[s._v("Kubernetes monitoring architecture"),n("OutboundLink")],1)])])]),s._v(" "),n("p",[s._v("最终能够在 "),n("code",[s._v("grafana")]),s._v(" 中收集到某一应用的内存监控实时图:")]),s._v(" "),n("p",[s._v("由于本部分设计内容过多，我将在以下的章节中进行介绍")]),s._v(" "),n("p",[n("strong",[s._v("这不仅仅适用于 node 服务，而且适用于一切 k8s 上的 "),n("code",[s._v("workload")])])]),s._v(" "),n("h2",{attrs:{id:"总结"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#总结"}},[s._v("#")]),s._v(" 总结")]),s._v(" "),n("p",[s._v("本章介绍了关于 Node 服务的内存在本地环境及生产环境的监控")]),s._v(" "),n("ol",[n("li",[s._v("本地使用 "),n("code",[s._v("htop/top")]),s._v(" 或者 "),n("code",[s._v("pidstat")]),s._v(" 监控进程内存及其原理")]),s._v(" "),n("li",[s._v("生产环境使用 "),n("code",[s._v("k8s/metric-server/prometheus/grafana")]),s._v(" 监控 node 整个应用的内存")])]),s._v(" "),n("p",[s._v("当监控到某一服务发生内存泄漏后，如何解决问题？因此接下来的文章将会讲到")]),s._v(" "),n("ol",[n("li",[s._v("生产环境是如何监控整个应用的内存的")]),s._v(" "),n("li",[s._v("当生产环境发生 OOM 后，如何快速定位")]),s._v(" "),n("li",[s._v("真实生产环境若干 OOM 的示例定位")])])])}),[],!1,null,null,null);t.default=e.exports}}]);