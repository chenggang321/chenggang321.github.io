(window.webpackJsonp=window.webpackJsonp||[]).push([[104],{523:function(t,s,n){"use strict";n.r(s);var a=n(40),e=Object(a.a)({},(function(){var t=this,s=t.$createElement,n=t._self._c||s;return n("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[n("h1",{attrs:{id:"浏览器跨域问题与服务器中的-cors"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#浏览器跨域问题与服务器中的-cors"}},[t._v("#")]),t._v(" 浏览器跨域问题与服务器中的 CORS")]),t._v(" "),n("blockquote",[n("p",[t._v("Access to XMLHttpRequest at 'xxx' from origin 'xxx' has been blocked by CORS policy: No 'Access-Control-Allow-Origin' header is present on the requested resource.")])]),t._v(" "),n("blockquote",[n("p",[n("a",{attrs:{href:"https://q.shanyue.tech/fe/js/216.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("什么是跨域？"),n("OutboundLink")],1)])]),t._v(" "),n("p",[t._v("跨域，这或许是前端面试中最常碰到的问题了，大概因为跨域问题是浏览器环境中的特有问题，而且随处可见，如同蚊子不仅盯你肉而且处处围着你转让你心烦。"),n("strong",[t._v("你看，在服务器发起 HTTP 请求就不会有跨域问题的")]),t._v("。")]),t._v(" "),n("p",[t._v("当谈到跨域问题的解决方案时，最流行也最简单的当属 CORS 了。")]),t._v(" "),n("h2",{attrs:{id:"cors"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#cors"}},[t._v("#")]),t._v(" CORS")]),t._v(" "),n("p",[t._v("CORS 即跨域资源共享 (Cross-Origin Resource Sharing, CORS)。简而言之，就是在服务器端的响应中加入几个标头，使得浏览器能够跨域访问资源。")]),t._v(" "),n("p",[t._v("这个响应头的字段设置就是 "),n("code",[t._v("Access-Control-Allow-Origin: *")]),t._v("，如下图所示")]),t._v(" "),n("p",[n("img",{attrs:{src:"https://mdn.mozillademos.org/files/17214/simple-req-updated.png",alt:"简单的 CORS 请求"}})]),t._v(" "),n("p",[t._v("以下是最简单的一个 CORS 请求")]),t._v(" "),n("div",{staticClass:"language-txt extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v("GET / HTTP/1.1\nHost: shanyue.tech\nOrigin: http://shanyue.tech\nUser-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_3) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/83.0.4103.116 Safari/537.36\n\nHTTP/1.1 200 OK\nAccess-Control-Allow-Origin: *\nContent-Type: text/plain; charset=utf-8\nContent-Length: 12\nDate: Wed, 08 Jul 2020 17:03:44 GMT\nConnection: keep-alive\n")])])]),n("h2",{attrs:{id:"预请求与-options"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#预请求与-options"}},[t._v("#")]),t._v(" 预请求与 Options")]),t._v(" "),n("p",[t._v("当一个请求跨域且不是简单请求时就会发起预请求，也就是 "),n("code",[t._v("Options")]),t._v("。如果没有预请求，万一有一个毁灭性的 POST 跨域请求直接执行，虽然最后告知浏览器你没有跨域权限，但是损失已造成，岂不亏大的。")]),t._v(" "),n("p",[t._v("以下条件构成了简单请求：")]),t._v(" "),n("ol",[n("li",[n("code",[t._v("Method")]),t._v(": 请求的方法是 "),n("code",[t._v("GET")]),t._v("、"),n("code",[t._v("POST")]),t._v(" 及 "),n("code",[t._v("HEAD")])]),t._v(" "),n("li",[n("code",[t._v("Header")]),t._v(": 请求头是 "),n("code",[t._v("Content-Type")]),t._v(" (有限制)、"),n("code",[t._v("Accept-Language")]),t._v("、"),n("code",[t._v("Content-Language")]),t._v(" 等")]),t._v(" "),n("li",[n("code",[t._v("Content-Type")]),t._v(": 请求类型是 "),n("code",[t._v("application/x-www-form-urlencoded")]),t._v("、"),n("code",[t._v("multipart/form-data")]),t._v(" 或 "),n("code",[t._v("text/plain")])])]),t._v(" "),n("p",[t._v("非简单请求一般需要开发者主动构造，在项目中常见的 "),n("code",[t._v("Content-Type: application/json")]),t._v(" 及 "),n("code",[t._v("Authorization: <token>")]),t._v(" 为典型的"),n("strong",[t._v("非简单请求")]),t._v("。与之有关的三个字段如下：")]),t._v(" "),n("ul",[n("li",[n("code",[t._v("Access-Control-Allow-Methods")]),t._v(": 请求所允许的方法, "),n("strong",[t._v("用于预请求 (preflight request) 中")])]),t._v(" "),n("li",[n("code",[t._v("Access-Control-Allow-Headers")]),t._v(": 请求所允许的头，"),n("strong",[t._v("用于预请求 (preflight request) 中")])]),t._v(" "),n("li",[n("code",[t._v("Access-Control-Max-Age")]),t._v(": 预请求的缓存时间")])]),t._v(" "),n("h2",{attrs:{id:"写一个-cors-middleware"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#写一个-cors-middleware"}},[t._v("#")]),t._v(" 写一个 CORS Middleware")]),t._v(" "),n("p",[t._v("既然 CORS 原理如此简单，那就拿起键盘写一个简单的 CORS 中间件吧，CORS 大致是设置几个响应头吧")]),t._v(" "),n("blockquote",[n("p",[n("a",{attrs:{href:"https://q.shanyue.tech/base/http/328.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("关于 cors 的响应头有哪些？"),n("OutboundLink")],1)])]),t._v(" "),n("p",[n("strong",[t._v("关于 CORS 的设置即是对 CORS 相关响应头的设置，因此了解这些 headers 至关重要。无论对于配置的生产者和消费者，及后端和前端而言，都应该掌握！")])]),t._v(" "),n("p",[t._v("以下是关于 CORS 相关的 response headers 及其释义")]),t._v(" "),n("ul",[n("li",[n("code",[t._v("Access-Control-Allow-Origin")]),t._v(": 可以把资源共享给那些域名，支持 * 及 特定域名")]),t._v(" "),n("li",[n("code",[t._v("Access-Control-Allow-Credentials")]),t._v(": 请求是否可以带 cookie")]),t._v(" "),n("li",[n("code",[t._v("Access-Control-Allow-Methods")]),t._v(": 请求所允许的方法, "),n("strong",[t._v("用于预请求 (preflight request) 中")])]),t._v(" "),n("li",[n("code",[t._v("Access-Control-Allow-Headers")]),t._v(": 请求所允许的头，"),n("strong",[t._v("用于预请求 (preflight request) 中")])]),t._v(" "),n("li",[n("code",[t._v("Access-Control-Expose-Headers")]),t._v(": 那些头可以在响应中列出")]),t._v(" "),n("li",[n("code",[t._v("Access-Control-Max-Age")]),t._v(": 预请求的缓存时间")])]),t._v(" "),n("p",[t._v("而关于 CORS 的中间件即是使用默认值与配置来设置这些头，如 "),n("code",[t._v("koa/cors")]),t._v(" 需要传递以下参数。")]),t._v(" "),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/**\n * CORS middleware\n *\n * @param {Object} [options]\n *  - {String|Function(ctx)} origin `Access-Control-Allow-Origin`, default is request Origin header\n *  - {String|Array} allowMethods `Access-Control-Allow-Methods`, default is 'GET,HEAD,PUT,POST,DELETE,PATCH'\n *  - {String|Array} exposeHeaders `Access-Control-Expose-Headers`\n *  - {String|Array} allowHeaders `Access-Control-Allow-Headers`\n *  - {String|Number} maxAge `Access-Control-Max-Age` in seconds\n *  - {Boolean|Function(ctx)} credentials `Access-Control-Allow-Credentials`, default is false.\n *  - {Boolean} keepHeadersOnError Add set headers to `err.header` if an error is thrown\n * @return {Function} cors middleware\n * @api public\n */")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Example")]),t._v("\napp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("use")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("cors")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),n("h2",{attrs:{id:"cors-如何设置多域名"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#cors-如何设置多域名"}},[t._v("#")]),t._v(" CORS 如何设置多域名")]),t._v(" "),n("p",[t._v("由上，貌似很简单，只需要服务端设置一下 "),n("code",[t._v("Access-Control-Allow-Origin")]),t._v(" 就可以轻松解决问题，但其中的坑有可能比你想象地要多很多！")]),t._v(" "),n("p",[t._v("先说回 "),n("code",[t._v("Access-Control-Allow-Origin")]),t._v("，它所允许的值只有两个")]),t._v(" "),n("ul",[n("li",[n("code",[t._v("*")]),t._v(": 所有域名")]),t._v(" "),n("li",[n("code",[t._v("shanyue.tech")]),t._v(": 特定域名")])]),t._v(" "),n("p",[t._v("此时，新问题来了:")]),t._v(" "),n("blockquote",[n("p",[n("a",{attrs:{href:"https://q.shanyue.tech/base/http/364.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("CORS 如果需要指定多个域名怎么办"),n("OutboundLink")],1)])]),t._v(" "),n("p",[n("strong",[t._v("如果使用 "),n("code",[t._v("Access-Control-Allow-Origin: *")]),t._v("，则所有的请求不能够携带 "),n("code",[t._v("cookie")])]),t._v("，因此这种方案被摈弃。")]),t._v(" "),n("p",[t._v("因此这个问题需要写代码来解决，根据请求头中的 Origin 来设置响应头 "),n("code",[t._v("Access-Control-Allow-Origin")])]),t._v(" "),n("ol",[n("li",[t._v("如果请求头不带有 Origin，证明未跨域，则不作任何处理")]),t._v(" "),n("li",[t._v("如果请求头带有 Origin，证明跨域，根据 Origin 设置相应的 "),n("code",[t._v("Access-Control-Allow-Origin: <Origin>")])])]),t._v(" "),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 获取 Origin 请求头")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" requestOrigin "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" ctx"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("get")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'Origin'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 如果没有，则跳过")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v("requestOrigin"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("next")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 设置响应头")]),t._v("\nctx"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("set")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'Access-Control-Allow-Origin'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" requestOrigin"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),n("p",[n("strong",[t._v("但此时会出现一个新的问题：缓存")])]),t._v(" "),n("h2",{attrs:{id:"cors-与-vary-origin"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#cors-与-vary-origin"}},[t._v("#")]),t._v(" CORS 与 Vary: Origin")]),t._v(" "),n("p",[t._v("在讨论与 "),n("code",[t._v("Vary")]),t._v(" 关系时，先抛出一个问题：")]),t._v(" "),n("blockquote",[n("p",[n("a",{attrs:{href:"https://q.shanyue.tech/base/http/330.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("如何避免 CDN 为 PC 端缓存移动端页面"),n("OutboundLink")],1)])]),t._v(" "),n("p",[t._v("假设有两个域名访问 "),n("code",[t._v("static.shanyue.tech")]),t._v(" 的跨域资源")]),t._v(" "),n("ol",[n("li",[n("code",[t._v("foo.shanyue.tech")]),t._v("，响应头中返回 "),n("code",[t._v("Access-Control-Allow-Origin: foo.shanyue.tech")])]),t._v(" "),n("li",[n("code",[t._v("bar.shanyue.tech")]),t._v("，响应头中返回 "),n("code",[t._v("Access-Control-Allow-Origin: bar.shanyue.tech")])])]),t._v(" "),n("p",[t._v("看起来一切正常，但平静的水面下波涛暗涌:")]),t._v(" "),n("p",[n("strong",[t._v("如果 "),n("code",[t._v("static.shanyue.tech")]),t._v(" 资源被 CDN 缓存，"),n("code",[t._v("bar.shanyue.tech")]),t._v(" 再次访问资源时，因缓存问题，因此此时返回的是 "),n("code",[t._v("Access-Control-Allow-Origin: foo.shanyue.tech")]),t._v("，此时会有跨域问题")])]),t._v(" "),n("p",[t._v("此时，"),n("code",[t._v("Vary: Origin")]),t._v(" 就上场了，代表为不同的 "),n("code",[t._v("Origin")]),t._v(" 缓存不同的资源，这在各个服务器端 CORS 中间件也能体现出来，如以下几段代码")]),t._v(" "),n("p",[t._v("此处是一段 koa 关于 CORS 的处理函数: 详见 "),n("a",{attrs:{href:"https://github.com/koajs/cors/blob/master/index.js#L54",target:"_blank",rel:"noopener noreferrer"}},[t._v("koajs/cors"),n("OutboundLink")],1)]),t._v(" "),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("async")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("cors")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("ctx"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" next")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// If the Origin header is not present terminate this set of steps.")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// The request is outside the scope of this specification.")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" requestOrigin "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" ctx"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("get")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'Origin'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Always set Vary header")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// https://github.com/rs/cors/issues/10")]),t._v("\n  ctx"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("vary")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'Origin'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),n("p",[t._v("此处是一段 Go 语言关于 CORS 的处理函数: 详见 "),n("a",{attrs:{href:"https://github.com/rs/cors/blob/be1c7e127af9fce006600894df5c5731d99cdc82/cors.go#L268",target:"_blank",rel:"noopener noreferrer"}},[t._v("rs/cors"),n("OutboundLink")],1)]),t._v(" "),n("div",{staticClass:"language-go extra-class"},[n("pre",{pre:!0,attrs:{class:"language-go"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("func")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("c "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("Cors"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("handleActualRequest")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("w http"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("ResponseWriter"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" r "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("http"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Request"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\theaders "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" w"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("Header")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\torigin "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" r"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Header"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("Get")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Origin"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Always set Vary, see https://github.com/rs/cors/issues/10")]),t._v("\n  headers"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("Add")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Vary"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Origin"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),n("p",[t._v("进一步改进相关代码：")]),t._v(" "),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 获取 Origin 请求头")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" requestOrigin "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" ctx"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("get")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'Origin'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 不管有没有跨域都要设置 Vary: Origin")]),t._v("\nctx"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("set")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'Vary'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'Origin'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 如果没有设置，说明没有跨域，跳过")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v("requestOrigin"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("next")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 设置响应头")]),t._v("\nctx"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("set")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'Access-Control-Allow-Origin'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" requestOrigin"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),n("p",[n("strong",[t._v("那此时是不关于 "),n("code",[t._v("CORS")]),t._v(" 的问题就解决了？从中间件处理层面是这样的，但仍然有一些服务端中间件使用问题及浏览器问题")])]),t._v(" "),n("h2",{attrs:{id:"hsts-与-cors"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#hsts-与-cors"}},[t._v("#")]),t._v(" HSTS 与 CORS")]),t._v(" "),n("p",[t._v("HSTS (HTTP Strict Transport Security) 为了避免 HTTP 跳转到 HTTPS 时遭受潜在的中间人攻击，由浏览器本身控制到 HTTPS 的跳转。如同 CORS 一样，它也是有一个服务器的响应头来控制")]),t._v(" "),n("div",{staticClass:"language-txt extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v("Strict-Transport-Security: max-age=5184000\n")])])]),n("p",[t._v("此时浏览器访问该域名时，会使用 "),n("code",[t._v("307 Internal Redirect")]),t._v("，无需服务器干涉，自动跳转到HTTPS请求。")]),t._v(" "),n("p",[n("strong",[t._v("如果前端访问 HTTP 跨域请求，此时浏览器通过 HSTS 跳转到 HTTPS，但浏览器不会给出相应的 CORS 响应头部，就会发生跨域问题。")])]),t._v(" "),n("div",{staticClass:"language-txt extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v("GET / HTTP/1.1\nHost: shanyue.tech\nOrigin: http://shanyue.tech\nUser-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_3) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/83.0.4103.116 Safari/537.36\n\nAccess to XMLHttpRequest at 'xxx' from origin 'xxx' has been blocked by CORS policy: No 'Access-Control-Allow-Origin' header is present on the requested resource.\n")])])]),n("h2",{attrs:{id:"服务器异常处理与跨域异常"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#服务器异常处理与跨域异常"}},[t._v("#")]),t._v(" 服务器异常处理与跨域异常")]),t._v(" "),n("p",[t._v("当与其他中间件一起工作时，也有可能出现问题，由于不正确的执行顺序也可能导致跨域失败。")]),t._v(" "),n("p",[t._v("假设有一个参数校验中间件，置于 CORS 中间件上方，由于校验失败，并未穿过 CORS 中间件，在前端会报错跨域失败，真正的参数校验问题掩盖其中。")]),t._v(" "),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" Koa "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'koa'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" app "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Koa")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" cors "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'@koa/cors'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 异常处理中间件")]),t._v("\napp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("use")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("async")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("ctx"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" next")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("try")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("next")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("catch")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("e"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    ctx"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("body "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'hello, error'")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 某一个特定时刻肯定会报错的中间件")]),t._v("\napp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("use")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("async")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("ctx"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" next")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("throw")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Error")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'hello, world'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// CORS 中间件")]),t._v("\napp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("use")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("cors")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\napp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("listen")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("3000")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),n("h2",{attrs:{id:"总结"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#总结"}},[t._v("#")]),t._v(" 总结")]),t._v(" "),n("p",[t._v("本篇文章介绍了跨域问题及其相应的 CORS 解决方案，并列出了若干细节问题。")]),t._v(" "),n("ol",[n("li",[t._v("CORS 通过服务器端设置若干响应头来正常工作")]),t._v(" "),n("li",[n("code",[t._v("Access-Control-Allow-Origin: *")]),t._v(" 无法携带 Cookie，因此以此为多域名跨域设置有缺陷")]),t._v(" "),n("li",[t._v("服务器端通过响应头 "),n("code",[t._v("Origin")]),t._v(" 来判断是否为跨域请求，并以此设置多域名跨域，但要加上 "),n("code",[t._v("Vary: Origin")])]),t._v(" "),n("li",[t._v("在编码过程中要注意 HSTS 配置及服务器的中间件顺序带来的潜在风险")])])])}),[],!1,null,null,null);s.default=e.exports}}]);