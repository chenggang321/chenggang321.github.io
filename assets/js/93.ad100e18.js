(window.webpackJsonp=window.webpackJsonp||[]).push([[93],{511:function(t,s,a){"use strict";a.r(s);var n=a(40),e=Object(n.a)({},(function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"使用-serverless-与-typescript-开发第一个-koa-应用"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#使用-serverless-与-typescript-开发第一个-koa-应用"}},[t._v("#")]),t._v(" 使用 serverless 与 typescript 开发第一个 Koa 应用")]),t._v(" "),a("p",[t._v("对于稍微大型的 Node 应用，"),a("code",[t._v("typescript")]),t._v(" 已经是标配，它为 "),a("code",[t._v("javascript")]),t._v(" 提供了强类型的铠甲，有效提高了代码质量。")]),t._v(" "),a("p",[t._v("这里是一个结合 "),a("code",[t._v("ts")]),t._v(" 及 "),a("code",[t._v("koa")]),t._v(" 快速部署到腾讯云函数计算中的模板。仓库见下")]),t._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"https://github.com/shfshanyue/serverless-template-zh",target:"_blank",rel:"noopener noreferrer"}},[t._v("shfshanyue/serverless-template-zh"),a("OutboundLink")],1),t._v(": 中国云厂商 serverless framework 模板及示例 （更快的访问速度）")])]),t._v(" "),a("h2",{attrs:{id:"快速使用"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#快速使用"}},[t._v("#")]),t._v(" 快速使用")]),t._v(" "),a("p",[t._v("使用本模板快速创建应用")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("$ serverless "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v(" --url https://github.com/shfshanyue/serverless-template-zh/tree/master/tencent-koa-ts --name koa-server\n")])])]),a("p",[t._v("在项目创建早期尽可能对 package 进行升级，这里使用了 "),a("code",[t._v("npm-check-updates")])]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("$ "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("npm")]),t._v(" run ncu\n")])])]),a("p",[t._v("在测试环境中进行开发")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("$ "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("npm")]),t._v(" run dev\n")])])]),a("h3",{attrs:{id:"文件结构"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#文件结构"}},[t._v("#")]),t._v(" 文件结构")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(".")]),t._v("\n├── dist/               "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 编译文件，及最终需要上传的目录")]),t._v("\n├── node_modules/\n├── app.ts              "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 入口文件，必须采用 app 的命名")]),t._v("\n├── package.json\n├── package-lock.json\n├── Readme.md\n├── serverless.yaml     "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# serverless 配置文件")]),t._v("\n└── tsconfig.json\n")])])]),a("h3",{attrs:{id:"app-ts"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#app-ts"}},[t._v("#")]),t._v(" app.ts")]),t._v(" "),a("p",[a("code",[t._v("app.ts")]),t._v(" 即是你业务逻辑的入口文件，你可以像其他 Koa Application 一样自由组织路由，业务逻辑，Model 等。")]),t._v(" "),a("div",{staticClass:"language-typescript extra-class"},[a("pre",{pre:!0,attrs:{class:"language-typescript"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" Koa "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'koa'")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" app "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Koa")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\napp"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("use")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("async")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ctx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" next"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  ctx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("body "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token template-string"}},[a("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("hello, path: '")]),a("span",{pre:!0,attrs:{class:"token interpolation"}},[a("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),t._v("ctx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("request"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("path"),a("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'")]),a("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")])]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\napp"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("listen")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3333")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("console")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'Listening 3333'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("module")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("exports "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" app\n")])])]),a("h3",{attrs:{id:"serverless-component"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#serverless-component"}},[t._v("#")]),t._v(" serverless component")]),t._v(" "),a("p",[a("code",[t._v("serverless component")]),t._v(" 可以认为是把 faas 及 baas 资源集合的进一步抽象，该项目采用了 "),a("code",[t._v("@serverless/tencent-koa")])]),t._v(" "),a("div",{staticClass:"language-yaml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("koa-app")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("component")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'@serverless/tencent-koa'")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("inputs")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("region")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" ap"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("guangzhou\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("functionName")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" koa"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("function\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("runtime")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" Nodejs10.15\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("code")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" ./dist\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("functionConf")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("timeout")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("60")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("memorySize")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("128")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("apigatewayConf")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("protocols")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" https\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("environment")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" release\n")])])]),a("h2",{attrs:{id:"部署"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#部署"}},[t._v("#")]),t._v(" 部署")]),t._v(" "),a("p",[t._v("部署之前需要准备好生产环境所需的 "),a("code",[t._v("node_modules")]),t._v(" 以及编译完成的 js 资源。")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 装包")]),t._v("\n$ "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("npm")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v(" typescript\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 编译成 js")]),t._v("\n$ "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("npm")]),t._v(" run build\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 打包生产环境的包，并移至 dist 目录")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# predeploy: npm ci --production && rsync -avz node_modules dist/")]),t._v("\n$ "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("npm")]),t._v(" run predeploy\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 部署到腾讯云")]),t._v("\n$ sls\nkoa-function "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("████████████████████████████████████████"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("100")]),t._v("% "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" ETA: 0s "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" Speed: "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("314")]),t._v(".98k/\n\n  koa-app:\n    functionName:        koa-function\n    functionOutputs:\n      ap-guangzhou:\n        Name:        koa-function\n        Runtime:     Nodejs10.15\n        Handler:     serverless-handler.handler\n        MemorySize:  "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("128")]),t._v("\n        Timeout:     "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("60")]),t._v("\n        Region:      ap-guangzhou\n        Namespace:   default\n        Description: This is a "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" created by serverless component\n    region:              ap-guangzhou\n    apiGatewayServiceId: service-dture22u\n    url:                 https://service-dture22u-1257314149.gz.apigw.tencentcs.com/release/\n    cns:                 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("empty array"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n  11s › koa-app › "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("done")]),t._v("\n")])])]),a("p",[t._v("从日志可以看出，部署到腾讯云只需 11s，还是很快速")]),t._v(" "),a("h2",{attrs:{id:"http-调用"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#http-调用"}},[t._v("#")]),t._v(" Http 调用")]),t._v(" "),a("p",[t._v("在本地直接使用 "),a("code",[t._v("npm run dev")]),t._v("，在本地端口调试。而在生产环境，使用 sls 部署后日志中提供的 url 进行 http 调用")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("$ "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("curl")]),t._v(" https://service-dture22u-1257314149.gz.apigw.tencentcs.com/release/\nhello, path: "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'/'")]),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# ")]),t._v("\n")])])]),a("h2",{attrs:{id:"缺点"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#缺点"}},[t._v("#")]),t._v(" 缺点")]),t._v(" "),a("p",[t._v("在开始之前，稍微提一下缺点：")]),t._v(" "),a("ol",[a("li",[t._v("部署麻烦，需要先编译 ts 至 js，并且仅上传生产环境需要的 node_modules (全部上传速度过慢)")]),t._v(" "),a("li",[t._v("在本地不支持 "),a("code",[t._v("log")]),t._v(" 及 "),a("code",[t._v("metrics")]),t._v("，需要转至腾讯云控制台查看")])]),t._v(" "),a("blockquote",[a("p",[t._v("由于部署过程稍微复杂，可以考虑重写一个关于 ts 的 serverless component")])])])}),[],!1,null,null,null);s.default=e.exports}}]);