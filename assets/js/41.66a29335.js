(window.webpackJsonp=window.webpackJsonp||[]).push([[41],{441:function(e,t,s){e.exports=s.p+"assets/img/drone.1035bed6.jpg"},601:function(e,t,s){"use strict";s.r(t);var n=s(40),a=Object(n.a)({},(function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[n("h1",{attrs:{id:"drone-ci-简介及部署"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#drone-ci-简介及部署"}},[e._v("#")]),e._v(" drone.ci 简介及部署")]),e._v(" "),n("p",[e._v("一般小型公司的持续集成方案会选择: "),n("code",[e._v("gitlab")]),e._v(" + "),n("code",[e._v("gitlab CI")]),e._v("，当然部分公司也会选择 "),n("code",[e._v("jenkins")]),e._v("。")]),e._v(" "),n("p",[e._v("选择 "),n("code",[e._v("gitlab CI")]),e._v(" 的原因很简单，因为使用了 "),n("code",[e._v("gitlab CE")]),e._v(" 作为代码托管平台。那为什么选择了 "),n("code",[e._v("gitlab")]),e._v(" 作为代码托管呢， "),n("code",[e._v("gitlab CE")]),e._v(" 是免费版(社区版)，对于昂贵的 toB 软件来说，一家公司至少省了几十万的开销，而且支持自建平台，搭在自家的服务器中，安全性得到了保证。")]),e._v(" "),n("p",[e._v("而对比 "),n("code",[e._v("gitlab")]),e._v(" 的同一类产品，世界最大的同性社交网站 "),n("code",[e._v("github")]),e._v(" 来说，随着微软的收购，"),n("code",[e._v("github")]),e._v(" 也越来越开放了，它不仅免费开放了私有仓库，现在也可以通过 "),n("code",[e._v("github action")]),e._v(" 来做简单的 CI。")]),e._v(" "),n("p",[e._v("对于个人，自有开发者以及小型公司来说，拥有免费仓库的 "),n("code",[e._v("github")]),e._v(" 也是一个不错的选择。")]),e._v(" "),n("p",[n("a",{attrs:{href:"https://drone.io/",target:"_blank",rel:"noopener noreferrer"}},[e._v("drone"),n("OutboundLink")],1),e._v(" 是基于容器的构建服务，配置简单且免费，在 github 上也有 20K star。如果你的仓库主要都在 github，你会喜欢上它的")]),e._v(" "),n("blockquote",[n("p",[e._v("随着 github action 的发展，github + github-action 也是个人以及小型公司可选的持续集成方案，不过由于它属于公共构建服务的缘故，镜像构建以及镜像拉取速度会是一个问题，这要取舍")])]),e._v(" "),n("p",[e._v("本篇文章单单介绍 "),n("code",[e._v("drone.ci")]),e._v(" 的部署")]),e._v(" "),n("ul",[n("li",[e._v("原文地址: "),n("a",{attrs:{href:"https://shanyue.tech/op/deploy-drone",target:"_blank",rel:"noopener noreferrer"}},[e._v("drone.ci 简介以及部署"),n("OutboundLink")],1)]),e._v(" "),n("li",[e._v("系列文章: "),n("a",{attrs:{href:"https://shanyue.tech/op",target:"_blank",rel:"noopener noreferrer"}},[e._v("个人服务器运维指南"),n("OutboundLink")],1)])]),e._v(" "),n("h2",{attrs:{id:"环境"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#环境"}},[e._v("#")]),e._v(" 环境")]),e._v(" "),n("p",[n("code",[e._v("kubernetes")]),e._v(" 集群，并使用 "),n("code",[e._v("helm")]),e._v(" 部署。如果不具备这两个条件可以参考我以前的文章")]),e._v(" "),n("ul",[n("li",[n("a",{attrs:{href:"https://github.com/shfshanyue/learn-k8s",target:"_blank",rel:"noopener noreferrer"}},[e._v("k8s 集群搭建"),n("OutboundLink")],1)]),e._v(" "),n("li",[n("a",{attrs:{href:"https://github.com/shfshanyue/learn-k8s/blob/master/helm.md",target:"_blank",rel:"noopener noreferrer"}},[e._v("k8s 中 helm 安装以及使用指南"),n("OutboundLink")],1)])]),e._v(" "),n("h2",{attrs:{id:"部署"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#部署"}},[e._v("#")]),e._v(" 部署")]),e._v(" "),n("blockquote",[n("p",[e._v("为了更好地真实环境效果，在命令演示过程中我会使用我真实的域名: "),n("code",[e._v("drone.xiange.tech")]),e._v("，你需要替换成你自己的域名")])]),e._v(" "),n("p",[e._v("部署时采用 helm 的官方 chart: "),n("a",{attrs:{href:"https://github.com/helm/charts/tree/master/stable/drone",target:"_blank",rel:"noopener noreferrer"}},[e._v("stable/drone"),n("OutboundLink")],1)]),e._v(" "),n("p",[e._v("当我们选择结合 "),n("code",[e._v("github")]),e._v(" 做CI，此时需要两个参数")]),e._v(" "),n("ol",[n("li",[n("code",[e._v("github oauth2 client-secret")])]),e._v(" "),n("li",[n("code",[e._v("github oauth2 client-id")])])]),e._v(" "),n("div",{staticClass:"language-bash extra-class"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# 根据 github oauth2 的 client-secret 创建一个 secret")]),e._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# generic: 指从文件或者字符串中创建")]),e._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# --form-literal: 根据键值对字符串创建")]),e._v("\n$ kubectl create secret generic drone-server-secrets --from-literal"),n("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("clientSecret"),n("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),n("span",{pre:!0,attrs:{class:"token string"}},[e._v('"'),n("span",{pre:!0,attrs:{class:"token variable"}},[e._v("${github-oauth2-client-secret}")]),e._v('"')]),e._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# 使用 helm v3 部署 stable/drone")]),e._v("\n$ helm "),n("span",{pre:!0,attrs:{class:"token function"}},[e._v("install")]),e._v(" drone stable/drone\n")])])]),n("p",[e._v("此时部署会提示部署失败，我们还需要一些必要的参数: "),n("code",[e._v("Ingress")]),e._v(" 以及 "),n("code",[e._v("github oauth2")])]),e._v(" "),n("p",[e._v("我们使用 "),n("code",[e._v("Ingress")]),e._v(" 配置域名 "),n("code",[e._v("drone.xiange.tech")]),e._v("，并开启 "),n("code",[e._v("https")]),e._v("，关于如何使用 "),n("code",[e._v("Ingress")]),e._v(" 并自动开启 "),n("code",[e._v("https")]),e._v("，可以参考我以前的文章:")]),e._v(" "),n("ol",[n("li",[n("a",{attrs:{href:"https://shanyue.tech/k8s/ingress",target:"_blank",rel:"noopener noreferrer"}},[e._v("通过外部域名访问你的应用: Ingress"),n("OutboundLink")],1)]),e._v(" "),n("li",[n("a",{attrs:{href:"https://shanyue.tech/k8s/https",target:"_blank",rel:"noopener noreferrer"}},[e._v("自动为你的域名添加 https"),n("OutboundLink")],1)])]),e._v(" "),n("p",[e._v("同时你也需要配置好默认 pv/pvc，可以参考我以前的文章")]),e._v(" "),n("ol",[n("li",[n("a",{attrs:{href:""}},[e._v("k8s 中的永久存储: PersistentVolume")])])]),e._v(" "),n("p",[e._v("配置相关的参数，存储为 "),n("code",[e._v("drone-values.yaml")]),e._v("，其中 "),n("code",[e._v("drone.xiange.tech")]),e._v(" 是在 github 上为 "),n("code",[e._v("drone")]),e._v(" 设置的回调域名")]),e._v(" "),n("div",{staticClass:"language-yaml extra-class"},[n("pre",{pre:!0,attrs:{class:"language-yaml"}},[n("code",[n("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("ingress")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v("\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[e._v("## If true, Drone Ingress will be created.")]),e._v("\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[e._v("##")]),e._v("\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("enabled")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" "),n("span",{pre:!0,attrs:{class:"token boolean important"}},[e._v("true")]),e._v("\n\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[e._v("## Drone Ingress annotations")]),e._v("\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[e._v("##")]),e._v("\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("annotations")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("kubernetes.io/ingress.class")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" nginx\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("kubernetes.io/tls-acme")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[e._v("'true'")]),e._v("\n\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[e._v("## Drone hostnames must be provided if Ingress is enabled")]),e._v("\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[e._v("##")]),e._v("\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("hosts")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v(" drone.xiange.tech\n\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[e._v("## Drone Ingress TLS configuration secrets")]),e._v("\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[e._v("## Must be manually created in the namespace")]),e._v("\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[e._v("##")]),e._v("\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("tls")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v(" "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("secretName")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" drone"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v("tls\n      "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("hosts")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v("\n        "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v(" drone.xiange.tech\n\n"),n("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("server")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v("\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[e._v("## If not set, it will be autofilled with the cluster host.")]),e._v("\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[e._v("## Host shoud be just the hostname.")]),e._v("\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[e._v("##")]),e._v("\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("host")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" drone.xiange.tech\n\n"),n("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("sourceControl")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v("\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[e._v("## your source control provider: github,gitlab,gitea,gogs,bitbucketCloud,bitbucketServer")]),e._v("\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("provider")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" github\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[e._v("## secret containing your source control provider secrets, keys provided below.")]),e._v("\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[e._v("## if left blank will assume a secret based on the release name of the chart.")]),e._v("\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("secret")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" drone"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v("server"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v("secrets\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[e._v("## Fill in the correct values for your chosen source control provider")]),e._v("\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[e._v("## Any key in this list with the suffix  will be fetched from the")]),e._v("\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[e._v("## secret named above, if not provided the secret it will be created as")]),e._v("\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[e._v('##  using for the key "ClientSecretKey" and')]),e._v("\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[e._v('# "clientSecretValue" for the value. Be awere to not leak shis file with your password')]),e._v("\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("github")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("clientSecretKey")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" clientSecret\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("server")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" https"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v("//github.com\n")])])]),n("p",[e._v("准备好 "),n("code",[e._v("values")]),e._v(" 之后，"),n("code",[e._v("helm upgrade")]),e._v(" 更新 chart 再次部署")]),e._v(" "),n("div",{staticClass:"language-bash extra-class"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[e._v("$ helm upgrade drone --reuse-values --values drone-values.yaml "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("\\")]),e._v(" \n  --set "),n("span",{pre:!0,attrs:{class:"token string"}},[e._v("'sourceControl.github.clientID={github-oauth2-client-id}'")]),e._v(" stable/drone\nRelease "),n("span",{pre:!0,attrs:{class:"token string"}},[e._v('"drone"')]),e._v(" has been upgraded. Happy Helming"),n("span",{pre:!0,attrs:{class:"token operator"}},[e._v("!")]),e._v("\nNAME: drone\nLAST DEPLOYED: "),n("span",{pre:!0,attrs:{class:"token number"}},[e._v("2019")]),e._v("-10-31 "),n("span",{pre:!0,attrs:{class:"token number"}},[e._v("15")]),e._v(":27:53.284739572 +0800 CST\nNAMESPACE: default\nSTATUS: deployed\nNOTES:\n*********************************************************************************\n***        PLEASE BE PATIENT: drone may take a few minutes to "),n("span",{pre:!0,attrs:{class:"token function"}},[e._v("install")]),e._v("         ***\n*********************************************************************************\nFrom outside the cluster, the server URL"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),e._v("s"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v(" are:\n     http://drone.xiange.tech\n")])])]),n("p",[e._v("查看 "),n("code",[e._v("deployment")]),e._v(" 状态，部署成功")]),e._v(" "),n("div",{staticClass:"language-bash extra-class"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[e._v("$ kubectl get deploy drone-drone-server\nNAME                 READY   UP-TO-DATE   AVAILABLE   AGE\ndrone-drone-server   "),n("span",{pre:!0,attrs:{class:"token number"}},[e._v("1")]),e._v("/1     "),n("span",{pre:!0,attrs:{class:"token number"}},[e._v("1")]),e._v("            "),n("span",{pre:!0,attrs:{class:"token number"}},[e._v("1")]),e._v("           6h44\n")])])]),n("p",[e._v("打开浏览器，查看域名 "),n("code",[e._v("drone.xiange.tech")]),e._v("，经过 "),n("code",[e._v("github")]),e._v(" 授权后可以看到 "),n("code",[e._v("drone.ci")]),e._v(" 的管理页面")]),e._v(" "),n("p",[n("img",{attrs:{src:s(441),alt:"drone部署成功"}})])])}),[],!1,null,null,null);t.default=a.exports}}]);