(window.webpackJsonp=window.webpackJsonp||[]).push([[111],{533:function(e,t,s){"use strict";s.r(t);var n=s(40),a=Object(n.a)({},(function(){var e=this,t=e.$createElement,s=e._self._c||t;return s("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[s("p",[e._v("date: 2020-08-25 21:00")]),e._v(" "),s("hr"),e._v(" "),s("h1",{attrs:{id:"node-中脚本异常时的退出码"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#node-中脚本异常时的退出码"}},[e._v("#")]),e._v(" Node 中脚本异常时的退出码")]),e._v(" "),s("p",[e._v("一个 Node 相关的项目中，总是少不了跑脚本。跑一个脚本拉取配置、处理一些数据以及定时任务更是家常便饭。")]),e._v(" "),s("p",[e._v("在一些重要流程中能够看到脚本的身影：")]),e._v(" "),s("ol",[s("li",[e._v("CI，用以测试、质量保障及部署等")]),e._v(" "),s("li",[e._v("Docker，用以构建镜像")]),e._v(" "),s("li",[e._v("Cron，用以定时任务")])]),e._v(" "),s("p",[e._v("如果在这些重要流程中脚本出错无法及时发现问题，将有可能引发更加隐蔽的问题。")]),e._v(" "),s("p",[e._v("最近观察项目镜像构建，会偶尔发现一两个镜像虽然构建成功，但容器却跑不起来的情况。"),s("strong",[e._v("究其原因，是因为 "),s("code",[e._v("Exit Code")]),e._v(" 的问题")]),e._v("。")]),e._v(" "),s("h2",{attrs:{id:"exit-code"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#exit-code"}},[e._v("#")]),e._v(" Exit Code")]),e._v(" "),s("blockquote",[s("p",[e._v("什么是 exit code?")])]),e._v(" "),s("p",[s("code",[e._v("exit code")]),e._v(" 代表一个进程的返回码，通过系统调用 "),s("code",[e._v("exit_group")]),e._v(" 来触发。在 "),s("code",[e._v("POSIX")]),e._v(" 中，"),s("code",[e._v("0")]),e._v(" 代表正常的返回码，"),s("code",[e._v("1-255")]),e._v(" 代表异常返回码，一般主动抛出的错误码都是 "),s("code",[e._v("1")]),e._v("。在 Node 应用中使用 "),s("code",[e._v("process.exitCode = 1")]),e._v(" 来代表因不期望的异常而中断。")]),e._v(" "),s("p",[e._v("这里有一张关于异常码的附表 "),s("a",{attrs:{href:"http://www.tldp.org/LDP/abs/html/exitcodes.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("Appendix E. Exit Codes With Special Meanings"),s("OutboundLink")],1),e._v("。")]),e._v(" "),s("p",[e._v("异常码在操作系统中随处可见，以下是一个关于 "),s("code",[e._v("cat")]),e._v(" 命令的异常以及它的 "),s("code",[e._v("exit code")]),e._v("，并使用 "),s("code",[e._v("strace")]),e._v(" 追踪系统调用。")]),e._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[e._v("$ "),s("span",{pre:!0,attrs:{class:"token function"}},[e._v("cat")]),e._v(" a\ncat: a: No such "),s("span",{pre:!0,attrs:{class:"token function"}},[e._v("file")]),e._v(" or directory\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# 使用 strace 查看 cat 的系统调用")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# -e 只显示 write 与 exit_group 的系统调用")]),e._v("\n$ "),s("span",{pre:!0,attrs:{class:"token function"}},[e._v("strace")]),e._v(" -e write,exit_group "),s("span",{pre:!0,attrs:{class:"token function"}},[e._v("cat")]),e._v(" a\nwrite"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("2")]),e._v(", "),s("span",{pre:!0,attrs:{class:"token string"}},[e._v('"cat: "')]),e._v(", 5cat: "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v("                    "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("5")]),e._v("\nwrite"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("2")]),e._v(", "),s("span",{pre:!0,attrs:{class:"token string"}},[e._v('"a"')]),e._v(", 1a"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v("                        "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("1")]),e._v("\nwrite"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("2")]),e._v(", "),s("span",{pre:!0,attrs:{class:"token string"}},[e._v('": No such file or directory"')]),e._v(", "),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("27")]),e._v(": No such "),s("span",{pre:!0,attrs:{class:"token function"}},[e._v("file")]),e._v(" or directory"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("27")]),e._v("\nwrite"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("2")]),e._v(", "),s("span",{pre:!0,attrs:{class:"token string"}},[e._v('"'),s("span",{pre:!0,attrs:{class:"token entity",title:"\\n"}},[e._v("\\n")]),e._v('"')]),e._v(", "),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("1")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v("                       "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("1")]),e._v("\nexit_group"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v("                           "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" ?\n+++ exited with "),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("1")]),e._v(" +++\n")])])]),s("p",[e._v("从系统调用的最后一行可以看出，该进行的 "),s("code",[e._v("exit code")]),e._v(" 是 1，并把错误信息输出到 "),s("code",[e._v("stderr")]),e._v(" (标准错误的 fd 为2) 中")]),e._v(" "),s("h2",{attrs:{id:"如何查看-exit-code"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#如何查看-exit-code"}},[e._v("#")]),e._v(" 如何查看 exit code")]),e._v(" "),s("p",[e._v("从 "),s("code",[e._v("strace")]),e._v(" 中可以来判断进程的 "),s("code",[e._v("exit code")]),e._v("，但是不够方便过于冗余，特别身处 shell 编程环境中。")]),e._v(" "),s("p",[s("strong",[e._v("有一种简单的方法，通过 "),s("code",[e._v("echo $?")]),e._v(" 来确认返回码")])]),e._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[e._v("$ "),s("span",{pre:!0,attrs:{class:"token function"}},[e._v("cat")]),e._v(" a\ncat: a: No such "),s("span",{pre:!0,attrs:{class:"token function"}},[e._v("file")]),e._v(" or directory\n\n$ "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[e._v("echo")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token variable"}},[e._v("$?")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("1")]),e._v("\n")])])]),s("h2",{attrs:{id:"throw-new-error-与-promise-reject-区别"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#throw-new-error-与-promise-reject-区别"}},[e._v("#")]),e._v(" "),s("code",[e._v("throw new Error")]),e._v(" 与 "),s("code",[e._v("Promise.reject")]),e._v(" 区别")]),e._v(" "),s("p",[e._v("以下是两段代码，第一段抛出一个异常，第二段 "),s("code",[e._v("Promise.reject")]),e._v("，两段代码都会如下打印出一段异常信息，那么两者有什么区别？")]),e._v(" "),s("div",{staticClass:"language-javascript extra-class"},[s("pre",{pre:!0,attrs:{class:"language-javascript"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("function")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[e._v("error")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("throw")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("new")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[e._v("Error")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[e._v("'hello, error'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n\n"),s("span",{pre:!0,attrs:{class:"token function"}},[e._v("error")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("// Output:")]),e._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("// /Users/shanyue/Documents/note/demo.js:2")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("//   throw new Error('hello, world')")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("//   ^")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("// ")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("// Error: hello, world")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("//     at error (/Users/shanyue/Documents/note/demo.js:2:9)")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("//     at Object.<anonymous> (/Users/shanyue/Documents/note/demo.js:5:1)")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("//     at Module._compile (internal/modules/cjs/loader.js:701:30)")]),e._v("\n")])])]),s("div",{staticClass:"language-javascript extra-class"},[s("pre",{pre:!0,attrs:{class:"language-javascript"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("async")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("function")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[e._v("error")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("return")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("new")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[e._v("Error")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[e._v("'hello, error'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n\n"),s("span",{pre:!0,attrs:{class:"token function"}},[e._v("error")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("// Output:")]),e._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("// (node:60356) UnhandledPromiseRejectionWarning: Error: hello, world")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("//    at error (/Users/shanyue/Documents/note/demo.js:2:9)")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("//    at Object.<anonymous> (/Users/shanyue/Documents/note/demo.js:5:1)")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("//    at Module._compile (internal/modules/cjs/loader.js:701:30)")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("//    at Object.Module._extensions..js (internal/modules/cjs/loader.js:712:10)")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("// (node:2787) UnhandledPromiseRejectionWarning: Unhandled promise rejection. This error originated either by throwing inside of an async function without a catch block, or by rejecting a promise which was not handled with .catch(). To terminate the node process on unhandled promise rejection, use the CLI flag `--unhandled-rejections=strict` (see https://nodejs.org/api/cli.html#cli_unhandled_rejections_mode). (rejection id: 1)")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("// (node:2787) [DEP0018] DeprecationWarning: Unhandled promise rejections are deprecated. In the future, promise rejections that are not handled will terminate the Node.js process with a non-zero exit code.")]),e._v("\n")])])]),s("p",[e._v("在对上述两个测试用例使用 "),s("code",[e._v("echo $?")]),e._v(" 查看 exit code，我们会发现 "),s("code",[e._v("throw new Error()")]),e._v(" 的 "),s("code",[e._v("exit code")]),e._v(" 为 1，而 "),s("code",[e._v("Promise.reject()")]),e._v(" 的为 0。")]),e._v(" "),s("p",[s("strong",[e._v("从操作系统的角度来讲，"),s("code",[e._v("exit code")]),e._v(" 为 0 代表进程成功运行并退出，此时即使有 "),s("code",[e._v("Promise.reject")]),e._v("，操作系统也会视为它执行成功。")])]),e._v(" "),s("p",[e._v("这在 "),s("code",[e._v("Dockerfile")]),e._v(" 与 "),s("code",[e._v("CI")]),e._v(" 中将留有安全隐患。")]),e._v(" "),s("h2",{attrs:{id:"dockerfile-在-node-中的注意点"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#dockerfile-在-node-中的注意点"}},[e._v("#")]),e._v(" Dockerfile 在 node 中的注意点")]),e._v(" "),s("p",[e._v("当使用 "),s("code",[e._v("Dockerfile")]),e._v(" 构建镜像时，如果 "),s("code",[e._v("RUN")]),e._v(" 的进程返回非0的返回码，构建就会失败。")]),e._v(" "),s("p",[s("strong",[e._v("而在 "),s("code",[e._v("Node")]),e._v(" 中的错误处理中，我们倾向于所有的异常都交由 "),s("code",[e._v("async/await")]),e._v(" 来处理，而当发生异常时，由于此时 exit code 为 0 并不会导致镜像构建失败。")])]),e._v(" "),s("p",[e._v("这是一个浅显易懂的含 "),s("code",[e._v("Promise.reject()")]),e._v(" 问题的镜像。")]),e._v(" "),s("div",{staticClass:"language-dockerfile extra-class"},[s("pre",{pre:!0,attrs:{class:"language-dockerfile"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("FROM")]),e._v(" node"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v("12"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v("alpine\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("RUN")]),e._v(" node "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v("e "),s("span",{pre:!0,attrs:{class:"token string"}},[e._v("\"Promise.reject('hello, world')\"")]),e._v("\n")])])]),s("p",[e._v("构建镜像过程如下："),s("strong",[e._v("即使在构建过程打印出了 "),s("code",[e._v("unhandledPromiseRejection")]),e._v(" 信息，但是镜像仍然构建成功。")])]),e._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[e._v("$ docker build -t demo "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[e._v(".")]),e._v("\nSending build context to Docker daemon  "),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("33")]),e._v(".28kB\nStep "),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("1")]),e._v("/2 "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[e._v(":")]),e._v(" FROM node:12-alpine\n ---"),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v(">")]),e._v(" 18f4bc975732\nStep "),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("2")]),e._v("/2 "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[e._v(":")]),e._v(" RUN node -e "),s("span",{pre:!0,attrs:{class:"token string"}},[e._v("\"Promise.reject('hello, world')\"")]),e._v("\n ---"),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v(">")]),e._v(" Running "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("in")]),e._v(" 79a6d53c5aa6\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),e._v("node:1"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v(" UnhandledPromiseRejectionWarning: hello, world\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),e._v("node:1"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v(" UnhandledPromiseRejectionWarning: Unhandled promise rejection. This error originated either by throwing inside of an async "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("function")]),e._v(" without a catch block, or by rejecting a promise "),s("span",{pre:!0,attrs:{class:"token function"}},[e._v("which")]),e._v(" was not handled with .catch"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v(". To terminate the node process on unhandled promise rejection, use the CLI flag "),s("span",{pre:!0,attrs:{class:"token variable"}},[s("span",{pre:!0,attrs:{class:"token variable"}},[e._v("`")]),e._v("--unhandled-rejections"),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("strict"),s("span",{pre:!0,attrs:{class:"token variable"}},[e._v("`")])]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),e._v("see https://nodejs.org/api/cli.html"),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("#cli_unhandled_rejections_mode). (rejection id: 1)")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),e._v("node:1"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("[")]),e._v("DEP0018"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("]")]),e._v(" DeprecationWarning: Unhandled promise rejections are deprecated. In the future, promise rejections that are not handled will terminate the Node.js process with a non-zero "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[e._v("exit")]),e._v(" code.\nRemoving intermediate container 79a6d53c5aa6\n ---"),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v(">")]),e._v(" 09f07eb993fe\nSuccessfully built 09f07eb993fe\nSuccessfully tagged demo:latest\n")])])]),s("h2",{attrs:{id:"promise-reject-脚本解决方案"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#promise-reject-脚本解决方案"}},[e._v("#")]),e._v(" Promise.reject 脚本解决方案")]),e._v(" "),s("p",[e._v("能在编译时能发现的问题，绝不要放在运行时。所以，构建镜像或 CI 中需要执行 node 脚本时，对异常处理需要手动指定 "),s("code",[e._v("process.exitCode = 1")]),e._v(" 来提前暴露问题")]),e._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[e._v("runScript")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[e._v("catch")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=>")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n  process"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("exitCode "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("1")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v("\n")])])]),s("p",[e._v("在构建镜像时，也有关于异常解决方案的建议：")]),e._v(" "),s("blockquote",[s("p",[e._v("(node:1) UnhandledPromiseRejectionWarning: Unhandled promise rejection. This error originated either by throwing inside of an async function without a catch block, or by rejecting a promise which was not handled with .catch(). To terminate the node process on unhandled promise rejection, use the CLI flag "),s("code",[e._v("--unhandled-rejections=strict")]),e._v(" (see https://nodejs.org/api/cli.html#cli_unhandled_rejections_mode). (rejection id: 1)")])]),e._v(" "),s("p",[e._v("根据提示，"),s("code",[e._v("--unhandled-rejections=strict")]),e._v(" 将会把 "),s("code",[e._v("Promise.reject")]),e._v(" 的退出码设置为 "),s("code",[e._v("1")]),e._v("，并在将来的 node 版本中修正 "),s("code",[e._v("Promise")]),e._v(" 异常退出码。")]),e._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[e._v("$ node --unhandled-rejections"),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("strict error.js \n")])])]),s("p",[s("code",[e._v("--unhandled-rejections=strict")]),e._v(" 的配置对 node 有版本要求：")]),e._v(" "),s("blockquote",[s("p",[e._v("Added in: v12.0.0, v10.17.0")]),e._v(" "),s("p",[e._v("By default all unhandled rejections trigger a warning plus a deprecation warning\nfor the very first unhandled rejection in case no unhandledRejection hook\nis used.")])]),e._v(" "),s("h2",{attrs:{id:"总结"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#总结"}},[e._v("#")]),e._v(" 总结")]),e._v(" "),s("ol",[s("li",[e._v("当进程结束的 exit code 为非 0 时，系统会认为该进程执行失败")]),e._v(" "),s("li",[e._v("通过 "),s("code",[e._v("echo $?")]),e._v(" 可查看终端上一进程的 exit code")]),e._v(" "),s("li",[e._v("Node 中 "),s("code",[e._v("Promise.reject")]),e._v(" 时 exit code 为 0")]),e._v(" "),s("li",[e._v("Node 中可以通过 "),s("code",[e._v("process.exitCode = 1")]),e._v(" 显式设置 exit code")]),e._v(" "),s("li",[e._v("在 Node12+ 中可以通过 "),s("code",[e._v("node --unhandled-rejections=strict error.js")]),e._v(" 执行脚本，视 "),s("code",[e._v("Promise.reject")]),e._v(" 的 "),s("code",[e._v("exit code")]),e._v(" 为 1")])])])}),[],!1,null,null,null);t.default=a.exports}}]);