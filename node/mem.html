<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>博客</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <meta name="description" content="一个值得收藏的博客，涵盖了前端、后端、运维等关键技术。">
    
    <link rel="preload" href="/assets/css/0.styles.decdc3e0.css" as="style"><link rel="preload" href="/assets/js/app.4f4ef6e8.js" as="script"><link rel="preload" href="/assets/js/2.b1de68ec.js" as="script"><link rel="preload" href="/assets/js/34.3a80866b.js" as="script"><link rel="prefetch" href="/assets/js/10.ab3f99ad.js"><link rel="prefetch" href="/assets/js/100.c81995d2.js"><link rel="prefetch" href="/assets/js/101.d6704593.js"><link rel="prefetch" href="/assets/js/102.a7a3e5a5.js"><link rel="prefetch" href="/assets/js/103.50f9015f.js"><link rel="prefetch" href="/assets/js/104.e2bee3c6.js"><link rel="prefetch" href="/assets/js/105.2ee035f2.js"><link rel="prefetch" href="/assets/js/106.3078fc48.js"><link rel="prefetch" href="/assets/js/107.e6576c7d.js"><link rel="prefetch" href="/assets/js/108.6e586c28.js"><link rel="prefetch" href="/assets/js/109.ecde7cf8.js"><link rel="prefetch" href="/assets/js/11.c48f519a.js"><link rel="prefetch" href="/assets/js/110.6641473f.js"><link rel="prefetch" href="/assets/js/111.8f2a5a0b.js"><link rel="prefetch" href="/assets/js/112.83d88710.js"><link rel="prefetch" href="/assets/js/113.bd8649a4.js"><link rel="prefetch" href="/assets/js/114.d80d74ff.js"><link rel="prefetch" href="/assets/js/115.e104d185.js"><link rel="prefetch" href="/assets/js/116.01177820.js"><link rel="prefetch" href="/assets/js/117.c97cce82.js"><link rel="prefetch" href="/assets/js/118.57091e41.js"><link rel="prefetch" href="/assets/js/119.fbc29d3d.js"><link rel="prefetch" href="/assets/js/12.4af41c18.js"><link rel="prefetch" href="/assets/js/120.9c94d5b1.js"><link rel="prefetch" href="/assets/js/121.a45c247c.js"><link rel="prefetch" href="/assets/js/122.18142e32.js"><link rel="prefetch" href="/assets/js/123.5111d68f.js"><link rel="prefetch" href="/assets/js/124.bab3e582.js"><link rel="prefetch" href="/assets/js/125.30969020.js"><link rel="prefetch" href="/assets/js/126.5fea7783.js"><link rel="prefetch" href="/assets/js/127.e8670bd7.js"><link rel="prefetch" href="/assets/js/128.635880cb.js"><link rel="prefetch" href="/assets/js/129.709853ca.js"><link rel="prefetch" href="/assets/js/13.3383eeb2.js"><link rel="prefetch" href="/assets/js/130.cb9c6e3d.js"><link rel="prefetch" href="/assets/js/131.47d3ded4.js"><link rel="prefetch" href="/assets/js/132.ac39324d.js"><link rel="prefetch" href="/assets/js/133.40c44fdc.js"><link rel="prefetch" href="/assets/js/134.2c87bf61.js"><link rel="prefetch" href="/assets/js/135.cd1ebec4.js"><link rel="prefetch" href="/assets/js/136.4c2976f3.js"><link rel="prefetch" href="/assets/js/137.af4cb7f3.js"><link rel="prefetch" href="/assets/js/138.2fca9d79.js"><link rel="prefetch" href="/assets/js/139.68b09848.js"><link rel="prefetch" href="/assets/js/14.10a5d7d6.js"><link rel="prefetch" href="/assets/js/140.83329d13.js"><link rel="prefetch" href="/assets/js/141.ce53e2d1.js"><link rel="prefetch" href="/assets/js/142.90de57a3.js"><link rel="prefetch" href="/assets/js/143.2ceb4dba.js"><link rel="prefetch" href="/assets/js/144.bb562f25.js"><link rel="prefetch" href="/assets/js/145.df7e837b.js"><link rel="prefetch" href="/assets/js/146.07c0d14b.js"><link rel="prefetch" href="/assets/js/147.29278301.js"><link rel="prefetch" href="/assets/js/148.214ec574.js"><link rel="prefetch" href="/assets/js/149.91a2b877.js"><link rel="prefetch" href="/assets/js/15.bbd8bb55.js"><link rel="prefetch" href="/assets/js/150.e682d7a9.js"><link rel="prefetch" href="/assets/js/151.7f512db9.js"><link rel="prefetch" href="/assets/js/152.bde5306e.js"><link rel="prefetch" href="/assets/js/153.ddd305dd.js"><link rel="prefetch" href="/assets/js/154.9ce2066d.js"><link rel="prefetch" href="/assets/js/155.6b4020df.js"><link rel="prefetch" href="/assets/js/156.e6646c1c.js"><link rel="prefetch" href="/assets/js/157.9b95854c.js"><link rel="prefetch" href="/assets/js/158.435aaec3.js"><link rel="prefetch" href="/assets/js/159.b19fafca.js"><link rel="prefetch" href="/assets/js/16.f42084e9.js"><link rel="prefetch" href="/assets/js/160.68710c08.js"><link rel="prefetch" href="/assets/js/161.f1af8369.js"><link rel="prefetch" href="/assets/js/162.48fcf4ef.js"><link rel="prefetch" href="/assets/js/163.06cd6567.js"><link rel="prefetch" href="/assets/js/164.769d0e38.js"><link rel="prefetch" href="/assets/js/165.cc786f58.js"><link rel="prefetch" href="/assets/js/166.8397915c.js"><link rel="prefetch" href="/assets/js/167.f330642c.js"><link rel="prefetch" href="/assets/js/168.7027298e.js"><link rel="prefetch" href="/assets/js/169.639addba.js"><link rel="prefetch" href="/assets/js/17.85928616.js"><link rel="prefetch" href="/assets/js/170.e464e07e.js"><link rel="prefetch" href="/assets/js/171.0c93f5f0.js"><link rel="prefetch" href="/assets/js/172.2bf96d48.js"><link rel="prefetch" href="/assets/js/173.d5f9688e.js"><link rel="prefetch" href="/assets/js/174.e2597c57.js"><link rel="prefetch" href="/assets/js/175.0db8dfdf.js"><link rel="prefetch" href="/assets/js/176.07d902fe.js"><link rel="prefetch" href="/assets/js/177.7ab96d33.js"><link rel="prefetch" href="/assets/js/178.336d8024.js"><link rel="prefetch" href="/assets/js/179.e3c6d94f.js"><link rel="prefetch" href="/assets/js/18.9934e679.js"><link rel="prefetch" href="/assets/js/180.df5400c0.js"><link rel="prefetch" href="/assets/js/181.0c7d5607.js"><link rel="prefetch" href="/assets/js/182.e888e6de.js"><link rel="prefetch" href="/assets/js/183.dce39526.js"><link rel="prefetch" href="/assets/js/184.431b197c.js"><link rel="prefetch" href="/assets/js/185.14793f4e.js"><link rel="prefetch" href="/assets/js/186.9568dba6.js"><link rel="prefetch" href="/assets/js/187.d3fd4988.js"><link rel="prefetch" href="/assets/js/188.aa6e0ffd.js"><link rel="prefetch" href="/assets/js/189.19e95b5f.js"><link rel="prefetch" href="/assets/js/19.ee04512f.js"><link rel="prefetch" href="/assets/js/190.0357c8ab.js"><link rel="prefetch" href="/assets/js/191.38a8d75e.js"><link rel="prefetch" href="/assets/js/192.88ad2e90.js"><link rel="prefetch" href="/assets/js/193.c40d1edf.js"><link rel="prefetch" href="/assets/js/194.5b1b41e8.js"><link rel="prefetch" href="/assets/js/195.760f24ae.js"><link rel="prefetch" href="/assets/js/196.6ffbac14.js"><link rel="prefetch" href="/assets/js/197.4a9b3a84.js"><link rel="prefetch" href="/assets/js/198.8f443da6.js"><link rel="prefetch" href="/assets/js/20.0aaa73a2.js"><link rel="prefetch" href="/assets/js/21.3f7c64b3.js"><link rel="prefetch" href="/assets/js/22.c0a7a6c8.js"><link rel="prefetch" href="/assets/js/23.f6eef774.js"><link rel="prefetch" href="/assets/js/24.bd35123b.js"><link rel="prefetch" href="/assets/js/25.8fcfb8ee.js"><link rel="prefetch" href="/assets/js/26.690a6980.js"><link rel="prefetch" href="/assets/js/27.19f45fe0.js"><link rel="prefetch" href="/assets/js/28.807fab84.js"><link rel="prefetch" href="/assets/js/29.0b6c2e62.js"><link rel="prefetch" href="/assets/js/3.579763e7.js"><link rel="prefetch" href="/assets/js/30.315a7e60.js"><link rel="prefetch" href="/assets/js/31.d5f68890.js"><link rel="prefetch" href="/assets/js/32.d1a6a3df.js"><link rel="prefetch" href="/assets/js/33.3f0448f8.js"><link rel="prefetch" href="/assets/js/35.365ffa2a.js"><link rel="prefetch" href="/assets/js/36.4a5a45e3.js"><link rel="prefetch" href="/assets/js/37.20e06547.js"><link rel="prefetch" href="/assets/js/38.4f772311.js"><link rel="prefetch" href="/assets/js/39.4c23d572.js"><link rel="prefetch" href="/assets/js/4.67785188.js"><link rel="prefetch" href="/assets/js/40.b322f222.js"><link rel="prefetch" href="/assets/js/41.66a29335.js"><link rel="prefetch" href="/assets/js/42.816686f3.js"><link rel="prefetch" href="/assets/js/43.000306d3.js"><link rel="prefetch" href="/assets/js/44.b02a4caf.js"><link rel="prefetch" href="/assets/js/45.8b184934.js"><link rel="prefetch" href="/assets/js/46.b6c9a6a4.js"><link rel="prefetch" href="/assets/js/47.866ecd20.js"><link rel="prefetch" href="/assets/js/48.d7b42bd4.js"><link rel="prefetch" href="/assets/js/49.2b954b65.js"><link rel="prefetch" href="/assets/js/5.cd5aa464.js"><link rel="prefetch" href="/assets/js/50.f8d28fa1.js"><link rel="prefetch" href="/assets/js/51.35847692.js"><link rel="prefetch" href="/assets/js/52.21725cad.js"><link rel="prefetch" href="/assets/js/53.523b2551.js"><link rel="prefetch" href="/assets/js/54.561bd3c9.js"><link rel="prefetch" href="/assets/js/55.0bf4813c.js"><link rel="prefetch" href="/assets/js/56.911d2a21.js"><link rel="prefetch" href="/assets/js/57.8be7f8ec.js"><link rel="prefetch" href="/assets/js/58.f7a8d551.js"><link rel="prefetch" href="/assets/js/59.a0099645.js"><link rel="prefetch" href="/assets/js/6.6af4007f.js"><link rel="prefetch" href="/assets/js/60.63904601.js"><link rel="prefetch" href="/assets/js/61.c222ba90.js"><link rel="prefetch" href="/assets/js/62.4512acf6.js"><link rel="prefetch" href="/assets/js/63.7fff9229.js"><link rel="prefetch" href="/assets/js/64.e13ed838.js"><link rel="prefetch" href="/assets/js/65.f5a83f6a.js"><link rel="prefetch" href="/assets/js/66.1eec7166.js"><link rel="prefetch" href="/assets/js/67.d08c50bb.js"><link rel="prefetch" href="/assets/js/68.eb803b99.js"><link rel="prefetch" href="/assets/js/69.2375bb03.js"><link rel="prefetch" href="/assets/js/7.df165250.js"><link rel="prefetch" href="/assets/js/70.33f1f6de.js"><link rel="prefetch" href="/assets/js/71.8bcdde8a.js"><link rel="prefetch" href="/assets/js/72.3c3c8dd8.js"><link rel="prefetch" href="/assets/js/73.e808082e.js"><link rel="prefetch" href="/assets/js/74.7ce1cdbc.js"><link rel="prefetch" href="/assets/js/75.21f62d3a.js"><link rel="prefetch" href="/assets/js/76.32052c0d.js"><link rel="prefetch" href="/assets/js/77.a41818c8.js"><link rel="prefetch" href="/assets/js/78.d68c2376.js"><link rel="prefetch" href="/assets/js/79.0b601b4b.js"><link rel="prefetch" href="/assets/js/8.ae557884.js"><link rel="prefetch" href="/assets/js/80.a4f6779f.js"><link rel="prefetch" href="/assets/js/81.84bdd118.js"><link rel="prefetch" href="/assets/js/82.fc561f2d.js"><link rel="prefetch" href="/assets/js/83.2f4de683.js"><link rel="prefetch" href="/assets/js/84.11c361d5.js"><link rel="prefetch" href="/assets/js/85.906325b5.js"><link rel="prefetch" href="/assets/js/86.a2fa9aca.js"><link rel="prefetch" href="/assets/js/87.5caf9cf4.js"><link rel="prefetch" href="/assets/js/88.09b23cce.js"><link rel="prefetch" href="/assets/js/89.cb58b8bb.js"><link rel="prefetch" href="/assets/js/9.28706e90.js"><link rel="prefetch" href="/assets/js/90.9d0167ea.js"><link rel="prefetch" href="/assets/js/91.8c109a6b.js"><link rel="prefetch" href="/assets/js/92.c8dde281.js"><link rel="prefetch" href="/assets/js/93.ad100e18.js"><link rel="prefetch" href="/assets/js/94.15c9e757.js"><link rel="prefetch" href="/assets/js/95.eed9740d.js"><link rel="prefetch" href="/assets/js/96.1d2dc1ce.js"><link rel="prefetch" href="/assets/js/97.0f5f9b90.js"><link rel="prefetch" href="/assets/js/98.8555cbfc.js"><link rel="prefetch" href="/assets/js/99.fa14ad63.js">
    <link rel="stylesheet" href="/assets/css/0.styles.decdc3e0.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/note/git/git-tips.html" class="nav-link">
  随记
</a></div><div class="nav-item"><a href="/study/javascript设计模式-张容铭/1-灵活的JavaScript.html" class="nav-link">
  学习笔记
</a></div> <a href="https://github.com/chenggang321/blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/note/git/git-tips.html" class="nav-link">
  随记
</a></div><div class="nav-item"><a href="/study/javascript设计模式-张容铭/1-灵活的JavaScript.html" class="nav-link">
  学习笔记
</a></div> <a href="https://github.com/chenggang321/blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <!----> </aside> <main class="page"> <div class="theme-default-content content__default"><p>date: 2020-07-02 20:00</p> <hr> <h1 id="如何监控-node-进程的内存"><a href="#如何监控-node-进程的内存" class="header-anchor">#</a> 如何监控 Node 进程的内存</h1> <p>刚开始，先抛出一个问题：</p> <blockquote><p>你知道你们生产环境的 Node 服务平时占用内存多少吗？或者说是多少量级？</p></blockquote> <p>山月在面试 Node 候选人时，这个问题足够筛掉一半的自称Node精通者，不过没有回答上来，我往往会再补充一个问题，以免漏掉优秀的无线上经验的候选人：</p> <blockquote><p><a href="https://q.shanyue.tech/base/linux/4.html#%E6%80%BB%E7%BB%93" target="_blank" rel="noopener noreferrer">如何知道某个进程消耗多少内存？<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></blockquote> <p><strong>当使用 Node 在生产环境作为服务器语言时，并发量过大或者代码问题造成 OOM (out of memory) 或者 CPU 满载这些都是服务器中常见的问题，此时通过监控 CPU 及内存，再结合日志及 Release 就很容易发现问题。</strong></p> <p>本章将介绍如何监控本地环境及生产环境的内存变化</p> <h2 id="一个-node-应用实例"><a href="#一个-node-应用实例" class="header-anchor">#</a> 一个 Node 应用实例</h2> <p>所以，如何动态监控一个 Node 进程的内存变化呢？</p> <p>以下是一个 Node Server 的示例，并且是一个有内存泄漏问题的示例，并且是山月在生产环境定位了很久的问题的精简版。</p> <blockquote><p>那次内存泄漏问题中，导致单个容器中的内存从原先的 400M 暴涨到 700M，在 800M 的容器资源限制下偶尔会发生 OOM，导致重启。一时没有定位到问题 (发现问题过迟，半个月前的时序数据已被吞没，于是未定位到 Release)，于是把资源限制上调到 1000M。后发现是由 ctx.request 挂载了数据库某个大字段而致</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> Koa <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">function</span> <span class="token function">getData</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> Array<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token function">Array</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">x</span> <span class="token operator">=&gt;</span> <span class="token number">10086</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  ctx<span class="token punctuation">.</span>data <span class="token operator">=</span> <span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token parameter">ctx</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token string">'hello, world'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3200</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Port: 3200'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="进程内存监控"><a href="#进程内存监控" class="header-anchor">#</a> 进程内存监控</h2> <p>一些问题需要在本地及测试环境得到及时扼杀，来避免在生产环境造成更大的影响。那么了解在本地如何监控内存就至关重要。</p> <p><code>pidstat</code> 是 <code>sysstat</code> 系列 linux 性能调试工具的一个包，竟然用它来调试 linux 的性能问题，包括内存，网络，IO，CPU 等。</p> <p><strong>这不仅试用与 <code>node</code>，而且适用于一切进程，包括 <code>python</code>，<code>java</code> 以及 <code>go</code></strong></p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># -r: 指输出内存指标</span>
<span class="token comment"># -p: 指定 pid</span>
<span class="token comment"># 1: 每一秒输出一次</span>
<span class="token comment"># 100: 输出100次</span>
$ pidstat -r -p pid <span class="token number">1</span> <span class="token number">100</span>
</code></pre></div><p>而在使用 <code>pidstat</code> 之前，需要先找到进程的 <code>pid</code></p> <h3 id="如何找到-node-进程的-pid"><a href="#如何找到-node-进程的-pid" class="header-anchor">#</a> 如何找到 Node 进程的 pid</h3> <p>在 <code>node</code> 中可以通过 <code>process.pid</code> 来找到进程的 <code>pid</code></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token operator">&gt;</span> process<span class="token punctuation">.</span>pid
<span class="token number">16425</span>
</code></pre></div><p>虽然通过写代码可以找到 <code>pid</code>，但是具有侵入性，不太实用。那如何通过非侵入的手段找到 <code>pid</code> 呢？有两种办法</p> <ol><li>通过多余的参数结合 <code>ps</code> 定位进程</li> <li>通过端口号结合 <code>lsof</code> 定位进程</li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code>$ node index.js shanyue

<span class="token comment"># 第一种方法：通过多余的参数快速定位 pid</span>
$ <span class="token function">ps</span> -ef <span class="token operator">|</span> <span class="token function">grep</span> shanyue
root     <span class="token number">31796</span> <span class="token number">23839</span>  <span class="token number">1</span> <span class="token number">16</span>:38 pts/5    00:00:00 node index.js shanyue

<span class="token comment"># 第二种方法：通过端口号定位 pid</span>
<span class="token function">lsof</span> -i:3200
COMMAND   PID <span class="token environment constant">USER</span>   FD   TYPE    DEVICE SIZE/OFF NODE NAME
node    <span class="token number">31796</span> root   20u  IPv6 <span class="token number">235987334</span>      0t0  TCP *:tick-port <span class="token punctuation">(</span>LISTEN<span class="token punctuation">)</span>
</code></pre></div><h2 id="使用-pidstat-监控内存"><a href="#使用-pidstat-监控内存" class="header-anchor">#</a> 使用 pidstat 监控内存</h2> <p><img src="https://camo.githubusercontent.com/4e63aceeef7797e78a5f4528478c7a30458dbca2/687474703a2f2f7777772e6272656e64616e67726567672e636f6d2f506572662f6c696e75785f706572665f746f6f6c735f66756c6c2e706e67" alt=""></p> <p>从以上代码中可以知道，node 服务的 pid 为 <code>31796</code>，为了可以观察到内存的动态变化，再施加一个压力测试</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ ab -c <span class="token number">10000</span> -n <span class="token number">1000000</span> http://localhost:3200/
</code></pre></div><div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># -r: 指输出内存指标</span>
<span class="token comment"># -p: 指定 pid</span>
<span class="token comment"># 1: 每一秒输出一次</span>
<span class="token comment"># 100: 输出100次</span>
$ pidstat -r -p <span class="token number">31796</span> <span class="token number">1</span> <span class="token number">100</span>
Linux <span class="token number">3.10</span>.0-957.21.3.el7.x86_64 <span class="token punctuation">(</span>shuifeng<span class="token punctuation">)</span>     <span class="token number">2020</span>年07月02日  _x86_64_        <span class="token punctuation">(</span><span class="token number">2</span> CPU<span class="token punctuation">)</span>

             <span class="token environment constant">UID</span>       PID  minflt/s  majflt/s     VSZ    RSS   %MEM  Command
<span class="token number">19</span>时20分39秒     <span class="token number">0</span>     <span class="token number">11401</span>      <span class="token number">0.00</span>      <span class="token number">0.00</span>  <span class="token number">566768</span>  <span class="token number">19800</span>   <span class="token number">0.12</span>  node
<span class="token number">19</span>时20分40秒     <span class="token number">0</span>     <span class="token number">11401</span>      <span class="token number">0.00</span>      <span class="token number">0.00</span>  <span class="token number">566768</span>  <span class="token number">19800</span>   <span class="token number">0.12</span>  node
<span class="token number">19</span>时20分41秒     <span class="token number">0</span>     <span class="token number">11401</span>   <span class="token number">9667.00</span>      <span class="token number">0.00</span>  <span class="token number">579024</span>  <span class="token number">37792</span>   <span class="token number">0.23</span>  node
<span class="token number">19</span>时20分42秒     <span class="token number">0</span>     <span class="token number">11401</span>  <span class="token number">11311.00</span>      <span class="token number">0.00</span>  <span class="token number">600716</span>  <span class="token number">59988</span>   <span class="token number">0.37</span>  node
<span class="token number">19</span>时20分43秒     <span class="token number">0</span>     <span class="token number">11401</span>   <span class="token number">5417.82</span>      <span class="token number">0.00</span>  <span class="token number">611420</span>  <span class="token number">70900</span>   <span class="token number">0.44</span>  node
<span class="token number">19</span>时20分44秒     <span class="token number">0</span>     <span class="token number">11401</span>   <span class="token number">3901.00</span>      <span class="token number">0.00</span>  <span class="token number">627292</span>  <span class="token number">85928</span>   <span class="token number">0.53</span>  node
<span class="token number">19</span>时20分45秒     <span class="token number">0</span>     <span class="token number">11401</span>   <span class="token number">1560.00</span>      <span class="token number">0.00</span>  <span class="token number">621660</span>  <span class="token number">81208</span>   <span class="token number">0.50</span>  node
<span class="token number">19</span>时20分46秒     <span class="token number">0</span>     <span class="token number">11401</span>   <span class="token number">2390.00</span>      <span class="token number">0.00</span>  <span class="token number">623964</span>  <span class="token number">83696</span>   <span class="token number">0.51</span>  node
<span class="token number">19</span>时20分47秒     <span class="token number">0</span>     <span class="token number">11401</span>   <span class="token number">1764.00</span>      <span class="token number">0.00</span>  <span class="token number">625500</span>  <span class="token number">85204</span>   <span class="token number">0.52</span>  node
</code></pre></div><p>对于输出指标的含义如下</p> <ul><li><code>RSS</code>: <code>Resident Set Size</code>，常驻内存集，可理解为内存，这就是我们需要监控的内存指标</li> <li><code>VSZ</code>: <code>virtual size</code>，虚拟内存</li></ul> <p>从输出可以看出，<strong>当施加了压力测试后，内存由 19M 涨到了 85M。</strong></p> <h2 id="使用-top-监控内存"><a href="#使用-top-监控内存" class="header-anchor">#</a> 使用 top 监控内存</h2> <p><code>pidstat</code> 是属于 <code>sysstat</code> 下的 linux 性能工具，但在 mac 中，如何定位内存的变化？</p> <p>此时可以使用 <code>top/htop</code></p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token function">htop</span> -p <span class="token number">31796</span>
</code></pre></div><p><img src="/assets/img/htop-pid.4e3b1a58.png" alt="使用 htop 监控内存"></p> <h2 id="内存监控原理"><a href="#内存监控原理" class="header-anchor">#</a> 内存监控原理</h2> <p>无论使用 <code>top/htop</code>，<code>pidstat</code> 及 <code>process.memoryUsage</code> 监控 Node 进程的内存，在 <code>linux</code> 中，其原理都是监听 <code>procfs</code> 文件变化</p> <ul><li><code>cat /proc/100/stat</code>: 100 号进程的信息，以机器读的格式输出</li> <li><code>cat /proc/100/status</code>: 100 好进程的信息，以可读的格式输出</li></ul> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># machine-readable</span>
$ <span class="token function">cat</span> /proc/100/stat
<span class="token number">100</span> <span class="token punctuation">(</span>kauditd<span class="token punctuation">)</span> S <span class="token number">2</span> <span class="token number">0</span> <span class="token number">0</span> <span class="token number">0</span> -1 <span class="token number">2105408</span> <span class="token number">0</span> <span class="token number">0</span> <span class="token number">0</span> <span class="token number">0</span> <span class="token number">0</span> <span class="token number">3455</span> <span class="token number">0</span> <span class="token number">0</span> <span class="token number">20</span> <span class="token number">0</span> <span class="token number">1</span> <span class="token number">0</span> <span class="token number">63</span> <span class="token number">0</span> <span class="token number">0</span> <span class="token number">18446744073709551615</span> <span class="token number">0</span> <span class="token number">0</span> <span class="token number">0</span> <span class="token number">0</span> <span class="token number">0</span> <span class="token number">0</span> <span class="token number">0</span> <span class="token number">2147483647</span> <span class="token number">0</span> <span class="token number">18446744072255378100</span> <span class="token number">0</span> <span class="token number">0</span> <span class="token number">17</span> <span class="token number">0</span> <span class="token number">0</span> <span class="token number">0</span> <span class="token number">0</span> <span class="token number">0</span> <span class="token number">0</span> <span class="token number">0</span> <span class="token number">0</span> <span class="token number">0</span> <span class="token number">0</span> <span class="token number">0</span> <span class="token number">0</span> <span class="token number">0</span> <span class="token number">0</span>

<span class="token comment"># human-readable</span>
$ <span class="token function">cat</span> /proc/100/status
Name:   kauditd
Umask:  0000
State:  S <span class="token punctuation">(</span>sleeping<span class="token punctuation">)</span>
Tgid:   <span class="token number">100</span>
Ngid:   <span class="token number">0</span>
Pid:    <span class="token number">100</span>
PPid:   <span class="token number">2</span>
TracerPid:      <span class="token number">0</span>
Uid:    <span class="token number">0</span>       <span class="token number">0</span>       <span class="token number">0</span>       <span class="token number">0</span>
Gid:    <span class="token number">0</span>       <span class="token number">0</span>       <span class="token number">0</span>       <span class="token number">0</span>
FDSize: <span class="token number">64</span>
Groups:
Threads:        <span class="token number">1</span>
SigQ:   <span class="token number">0</span>/63460
SigPnd: 0000000000000000
ShdPnd: 0000000000000000
SigBlk: 0000000000000000
SigIgn: ffffffffffffffff
SigCgt: 0000000000000000
CapInh: 0000000000000000
CapPrm: 0000001fffffffff
CapEff: 0000001fffffffff
CapBnd: 0000001fffffffff
CapAmb: 0000000000000000
Seccomp:        <span class="token number">0</span>
Speculation_Store_Bypass:       vulnerable
Cpus_allowed:   <span class="token number">3</span>
Cpus_allowed_list:      <span class="token number">0</span>-1
Mems_allowed:   00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000001
Mems_allowed_list:      <span class="token number">0</span>
voluntary_ctxt_switches:        <span class="token number">2353755</span>
nonvoluntary_ctxt_switches:     <span class="token number">26</span>
</code></pre></div><h2 id="生产环境内存监控"><a href="#生产环境内存监控" class="header-anchor">#</a> 生产环境内存监控</h2> <p>由于目前生产环境大都部署在 <code>k8s</code>，<strong>因此生产环境对于某个应用的内存监控本质上是 k8s 对于某个 <code>workload/deployment</code> 的内存监控</strong>，关于内存监控 <code>metric</code> 的数据流向大致如下:</p> <p><code>k8s</code> -&gt; <code>metric server</code> -&gt; <code>prometheus</code> -&gt; <code>grafana</code></p> <p>架构图如下：</p> <p><img src="https://camo.githubusercontent.com/371929b70ccb8f3b38410047586143399a60bb6d/68747470733a2f2f34373868356d3179726673613362626532363275376d75762d7770656e67696e652e6e6574646e612d73736c2e636f6d2f77702d636f6e74656e742f75706c6f6164732f323031382f30382f70726f6d6574686575735f6b756265726e657465735f6469616772616d5f6f766572766965772e706e67" alt=""></p> <p><img src="https://raw.githubusercontent.com/kubernetes/community/master/contributors/design-proposals/instrumentation/monitoring_architecture.png" alt=""></p> <blockquote><p>以上图片取自以下文章</p> <ul><li><a href="https://sysdig.com/blog/kubernetes-monitoring-prometheus/" target="_blank" rel="noopener noreferrer">Kubernetes Monitoring with Prometheus<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://github.com/kubernetes/community/blob/master/contributors/design-proposals/instrumentation/monitoring_architecture.md" target="_blank" rel="noopener noreferrer">Kubernetes monitoring architecture<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></blockquote> <p>最终能够在 <code>grafana</code> 中收集到某一应用的内存监控实时图:</p> <p>由于本部分设计内容过多，我将在以下的章节中进行介绍</p> <p><strong>这不仅仅适用于 node 服务，而且适用于一切 k8s 上的 <code>workload</code></strong></p> <h2 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h2> <p>本章介绍了关于 Node 服务的内存在本地环境及生产环境的监控</p> <ol><li>本地使用 <code>htop/top</code> 或者 <code>pidstat</code> 监控进程内存及其原理</li> <li>生产环境使用 <code>k8s/metric-server/prometheus/grafana</code> 监控 node 整个应用的内存</li></ol> <p>当监控到某一服务发生内存泄漏后，如何解决问题？因此接下来的文章将会讲到</p> <ol><li>生产环境是如何监控整个应用的内存的</li> <li>当生产环境发生 OOM 后，如何快速定位</li> <li>真实生产环境若干 OOM 的示例定位</li></ol></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">3/1/2021, 2:03:31 PM</span></div></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.4f4ef6e8.js" defer></script><script src="/assets/js/2.b1de68ec.js" defer></script><script src="/assets/js/34.3a80866b.js" defer></script>
  </body>
</html>
